<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êàë‰ª¨ÁöÑÂõûÂøÜ | Êµ™Êº´Áõ∏ÂÜå</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2.5rem;
            font-weight: 600;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.2rem;
        }

        .upload-container {
            background-color: #f9f9f9;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .upload-btn {
            background-color: #ff6b6b;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
            margin: 10px;
        }

        .upload-btn:hover {
            background-color: #ff5252;
        }

        .sort-container {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .sort-btn {
            background-color: #f0f0f0;
            color: #333;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .sort-btn:hover, .sort-btn.active {
            background-color: #ff6b6b;
            color: white;
        }

        .photos-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 30px;
        }

        .photo-card {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .photo-img {
            width: 100%;
            height: auto;
            display: block;
            cursor: pointer;
        }

        .photo-date {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
        }

        .photo-memory {
            padding: 15px;
            text-align: left;
            color: #333;
        }
        
        .delete-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(255, 0, 0, 0.7);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.2s ease;
        }
        
        .delete-btn:hover {
            background-color: rgba(255, 0, 0, 0.9);
            transform: scale(1.1);
        }

        .photo-memory-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 10px;
            font-family: inherit;
        }

        .save-memory-btn {
            background-color: #4CAF50;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .save-memory-btn:hover {
            background-color: #45a049;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow: auto;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            max-width: 80%;
            max-height: 80%;
        }

        .modal-img {
            width: 100%;
            height: auto;
            border-radius: 5px;
        }

        .close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        .heart-icon {
            color: #ff6b6b;
            font-size: 1.5rem;
            margin: 0 5px;
        }

        @media (max-width: 768px) {
            .photos-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
</head>
<body>
    <div class="container">
        <h1><span class="heart-icon">‚ù§Ô∏è</span>Êàë‰ª¨ÁöÑÂõûÂøÜ<span class="heart-icon">‚ù§Ô∏è</span></h1>
        <p class="subtitle">ËÆ∞ÂΩïÊØè‰∏Ä‰∏™ÁæéÂ•ΩÁû¨Èó¥</p>
        
        <div class="upload-container">
            <label for="photo-upload" class="upload-btn">
                üì∑ ÁÇπÂáª‰∏ä‰º†ÁÖßÁâá
            </label>
            <input type="file" id="photo-upload" accept="image/*" style="display: none;" multiple>
            <p>ÊîØÊåÅÁÇπÂáªÔºåÂ∞ÜËá™Âä®Ë∞ÉÊï¥Âπ∂Ê∑ªÂä†Âà∞Áõ∏ÂÜå</p>
        </div>
        
        <div class="sort-container">
            <button class="sort-btn" onclick="changeSort('date-desc')">ÊúÄÊñ∞‰ºòÂÖà</button>
            <button class="sort-btn" onclick="changeSort('date-asc')">ÊúÄÊó©‰ºòÂÖà</button>
        </div>
        
        <div id="photos-container" class="photos-container">
            <!-- ÁÖßÁâáÂ∞ÜÂú®ËøôÈáåÂä®ÊÄÅÂä†ËΩΩ -->
        </div>
    </div>
    
    <div id="modal" class="modal">
        <span class="close" onclick="closeModal()">&times;</span>
        <img class="modal-content" id="modal-img">
    </div>
    
    <script>
        // FirebaseÈÖçÁΩÆ
        const firebaseConfig = {
            apiKey: "AIzaSyDFdBeoY2IKG_O23tiAtpK2gLuTfyaGaYk",
            authDomain: "photo-memory-596ef.firebaseapp.com",
            projectId: "photo-memory-596ef",
            storageBucket: "photo-memory-596ef.firebasestorage.app",
            messagingSenderId: "963316273567",
            appId: "1:963316273567:web:10ac3d837aa19afee12daa",
            measurementId: "G-BTHDGQERVF",
            databaseURL: "https://photo-memory-596ef-default-rtdb.firebaseio.com" // Ê∑ªÂä†Realtime Database URL
        };
        
        // ÂàùÂßãÂåñFirebase
        firebase.initializeApp(firebaseConfig);
        
        // Ëé∑ÂèñFirebaseÊúçÂä°ÂºïÁî®
        const storage = firebase.storage();
        const auth = firebase.auth();
        const firestore = firebase.firestore();
        
        // Ê∑ªÂä†ËØäÊñ≠Êó•Âøó
        console.log('FirebaseÂàùÂßãÂåñÂÆåÊàê');
        console.log('FirestoreÂºïÁî®:', firestore);
        console.log('StorageÂºïÁî®:', storage);
        
        // ‰ΩøÁî®FirestoreÂ≠òÂÇ®ÁÖßÁâáÊï∞ÊçÆ
        // ‰ΩøÁî®ÂÖ±‰∫´Áõ∏ÂÜåID‰Ωú‰∏∫ÈõÜÂêàÂêçÁß∞‰∏ÄÈÉ®ÂàÜÔºå‰ª•Á°Æ‰øùÊâÄÊúâËÆæÂ§áËÆøÈóÆÁõ∏ÂêåÁöÑÈõÜÂêà
        const albumId = 'shared-album';
        // ‰ΩøÁî®Âõ∫ÂÆöÁõ∏ÂÜåID‰Ωú‰∏∫ÈõÜÂêàË∑ØÂæÑÔºåÁ°Æ‰øùÊâÄÊúâËÆæÂ§áËÆøÈóÆÁõ∏ÂêåÁöÑÊï∞ÊçÆ
        const photosCollection = firestore.collection('albums').doc(albumId).collection('photos');
        console.log('‰ΩøÁî®ÂÖ±‰∫´Áõ∏ÂÜåÈõÜÂêàË∑ØÂæÑ: albums/' + albumId + '/photos');
        
        // ÁÖßÁâáÊï∞ÊçÆÂíåÊéíÂ∫èËÆæÁΩÆ
        let photos = [];
        let currentSort = 'date-desc';
        let syncInterval;
        
        // ÂàõÂª∫ÊàñËé∑ÂèñÂÖ±‰∫´ËÆøÈóÆÂØÜÈí•ÔºåÁî®‰∫éË∑®ËÆæÂ§áËÆøÈóÆ
        let sharedAccessKey = localStorage.getItem('sharedAccessKey');
        if (!sharedAccessKey) {
            // Â¶ÇÊûúÊ≤°ÊúâÂ≠òÂÇ®ÁöÑËÆøÈóÆÂØÜÈí•ÔºåÂàõÂª∫‰∏Ä‰∏™Êñ∞ÁöÑ
            sharedAccessKey = 'shared-album-' + Date.now();
            localStorage.setItem('sharedAccessKey', sharedAccessKey);
            console.log('ÂàõÂª∫‰∫ÜÊñ∞ÁöÑÂÖ±‰∫´ËÆøÈóÆÂØÜÈí•:', sharedAccessKey);
        } else {
            console.log('‰ΩøÁî®Áé∞ÊúâÂÖ±‰∫´ËÆøÈóÆÂØÜÈí•:', sharedAccessKey);
        }
        
        // ÂåøÂêçÁôªÂΩï
        console.log('ÂºÄÂßãÂåøÂêçÁôªÂΩï...');
        auth.signInAnonymously()
            .then((userCredential) => {
                console.log('ÂåøÂêçÁôªÂΩïÊàêÂäü');
                console.log('Áî®Êà∑ID:', userCredential.user.uid);
                
                // Â∞ÜÂÖ±‰∫´ËÆøÈóÆÂØÜÈí•Ê∑ªÂä†Âà∞Áî®Êà∑ÁöÑËá™ÂÆö‰πâÂ£∞Êòé‰∏≠
                const user = userCredential.user;
                user.getIdToken(true).then(function(token) {
                    console.log('Ëé∑ÂèñÂà∞Áî®Êà∑‰ª§ÁâåÔºåËÆæÁΩÆÂÖ±‰∫´ËÆøÈóÆ');
                });
                console.log('Áî®Êà∑ÂØπË±°:', userCredential.user);
                // ÁôªÂΩïÊàêÂäüÂêéÂä†ËΩΩÁÖßÁâá
                loadPhotosFromFirebase();
                
                // ËÆæÁΩÆ‰∏ä‰º†ÊåâÈíÆÁõëÂê¨Âô®
                setupUploadListener();
            })
            .catch(error => {
                console.error(' ÂåøÂêçÁôªÂΩïÂ§±Ë¥•:', error);
                console.error('ÈîôËØØ‰ª£Á†Å:', error.code);
                console.error('ÈîôËØØ‰ø°ÊÅØ:', error.message);
                // Âç≥‰ΩøÁôªÂΩïÂ§±Ë¥•‰πü‰ªéÊú¨Âú∞Âä†ËΩΩÁÖßÁâá
                loadPhotosFromLocalStorage();
                
                // ÁôªÂΩïÂ§±Ë¥•‰πüË¶ÅËÆæÁΩÆ‰∏ä‰º†ÊåâÈíÆÁõëÂê¨Âô®
                setupUploadListener();
            });
        
        // Flag to prevent multiple simultaneous upload processing
        let isProcessingUpload = false;

        // Ê∑ªÂä†Êñá‰ª∂‰∏ä‰º†‰∫ã‰ª∂ÁõëÂê¨Âô®
        function setupUploadListener() {
            console.log('ËÆæÁΩÆ‰∏ä‰º†ÊåâÈíÆÁõëÂê¨Âô®...');
            const uploadInput = document.getElementById('photo-upload');
            if (uploadInput) {
                console.log('ÊâæÂà∞‰∏ä‰º†ÊåâÈíÆÂÖÉÁ¥†:', uploadInput);
                uploadInput.addEventListener('change', async function(event) { // Made event handler async
                    if (isProcessingUpload) {
                        console.warn('‰∏ä‰º†Â§ÑÁêÜ‰∏≠ÔºåÂøΩÁï•Ê≠§Ê¨°Êñá‰ª∂ÈÄâÊã©‰∫ã‰ª∂„ÄÇ');
                        event.target.value = null; // Clear input to allow re-selection if needed
                        return;
                    }
                    isProcessingUpload = true;

                    console.log('Ê£ÄÊµãÂà∞Êñá‰ª∂ÈÄâÊã©‰∫ã‰ª∂');
                    const files = event.target.files;
                    console.log('ÈÄâÊã©ÁöÑÊñá‰ª∂Êï∞Èáè:', files ? files.length : 0);
                    if (files && files.length > 0) {
                        for (let i = 0; i < files.length; i++) {
                            console.log('ÂºÄÂßãÂ§ÑÁêÜÁ¨¨', i+1, '‰∏™Êñá‰ª∂:', files[i].name);
                            try {
                                // Assuming processAndUploadPhoto might involve async operations or return a Promise
                                await processAndUploadPhoto(files[i]);
                            } catch (error) {
                                console.error('Â§ÑÁêÜÊàñ‰∏ä‰º†Êñá‰ª∂Êó∂Âá∫Èîô:', files[i].name, error);
                                // Consider adding user feedback here if a specific file fails
                            }
                        }
                    }
                    
                    // Reset the flag after all files in the current selection have been processed (or attempted)
                    isProcessingUpload = false;
                    // Clear the file input to allow re-selection of the same file(s) if the user wants to.
                    // This is important because without it, selecting the same file again might not trigger the 'change' event.
                    event.target.value = null;
                });
                console.log('‰∏ä‰º†ÊåâÈíÆÁõëÂê¨Âô®ËÆæÁΩÆÊàêÂäü');
            } else {
                console.error('Êâæ‰∏çÂà∞‰∏ä‰º†ÊåâÈíÆÂÖÉÁ¥†!');
            }
        }
        
        // Â§ÑÁêÜÂíå‰∏ä‰º†ÁÖßÁâá
        function processAndUploadPhoto(file) {
            console.log('ÂºÄÂßãÂ§ÑÁêÜÁÖßÁâá:', file.name, 'Â§ßÂ∞è:', (file.size / 1024 / 1024).toFixed(2), 'MB', 'Á±ªÂûã:', file.type);
            
            // Ê£ÄÊü•Êñá‰ª∂Á±ªÂûã
            if (!file.type.startsWith('image/')) {
                // Ê£ÄÊü•Êñá‰ª∂ÂêçÊâ´Â∞æÔºåÂÖÅËÆ∏‰∏Ä‰∫õÂ∏∏ËßÅÁöÑÂõæÁâáÊ†ºÂºè
                const fileName = file.name.toLowerCase();
                const validExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.heic', '.heif'];
                const isValidExtension = validExtensions.some(ext => fileName.endsWith(ext));
                
                if (!isValidExtension) {
                    console.error('Êó†ÊïàÁöÑÊñá‰ª∂Á±ªÂûã:', file.type, 'Êñá‰ª∂Âêç:', fileName);
                    alert('ËØ∑ÈÄâÊã©ÊúâÊïàÁöÑÂõæÁâáÊñá‰ª∂ (JPG, PNG, GIFÁ≠â)');
                    return;
                }
                
                console.warn('Êñá‰ª∂MIMEÁ±ªÂûã‰∏çÊòØimage/Ôºå‰ΩÜÊñá‰ª∂Êâ©Â±ïÂêçÊúâÊïàÔºåÂ∞ùËØïÂ§ÑÁêÜ:', fileName);
            }
            
            // ÊúÄÂ§ßÂÖÅËÆ∏Â§ßÂ∞èÔºå10MB
            const maxFileSize = 10 * 1024 * 1024;
            if (file.size > maxFileSize) {
                console.warn('Êñá‰ª∂Ë∂ÖËøáÂ§ßÂ∞èÈôêÂà∂:', (file.size / 1024 / 1024).toFixed(2), 'MB');
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                console.log('Êñá‰ª∂ËØªÂèñÂÆåÊàê');
                const img = new Image();
                
                img.onload = function() {
                    console.log('ÂõæÁâáÂ∞∫ÂØ∏:', img.width, 'x', img.height);
                    
                    // ÂéãÁº©Â§ßÂõæÁâá
                    let imageDataUrl = e.target.result;
                    if (file.size > maxFileSize) {
                        console.log('ÂºÄÂßãÂéãÁº©ÂõæÁâá...');
                        imageDataUrl = compressImage(img, file.type);
                        console.log('ÂõæÁâáÂéãÁº©ÂÆåÊàê');
                    }
                    
                    // ÂàõÂª∫ÁÖßÁâáÊï∞ÊçÆÂØπË±°
                    const photoData = {
                        id: Date.now() + Math.floor(Math.random() * 1000),
                        name: file.name,
                        src: imageDataUrl,
                        date: new Date().toISOString(),
                        memory: ''
                    };
                    
                    // ‰∏ä‰º†Âà∞Firebase
                    uploadPhotoToFirebase(photoData);
                };
                
                img.onerror = function() {
                    console.error('Âä†ËΩΩÂõæÁâáÂá∫Èîô');
                    alert('Êó†Ê≥ïÂä†ËΩΩÊâÄÈÄâÂõæÁâáÔºåËØ∑Á°Æ‰øùÊñá‰ª∂ÂÆåÂ•Ω');
                };
                
                img.src = e.target.result;
            };
            
            reader.onerror = function() {
                console.error('ËØªÂèñÊñá‰ª∂Âá∫Èîô');
                alert('ËØªÂèñÊñá‰ª∂Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
            };
            
            reader.readAsDataURL(file);
        }
        
        // ÂéãÁº©ÂõæÁâá
        function compressImage(img, mimeType) {
            console.log('ÂéãÁº©ÂâçÂõæÁâáÂ∞∫ÂØ∏:', img.width, 'x', img.height, 'Á±ªÂûã:', mimeType);
            
            // Â§ÑÁêÜÁâπÊÆäÊ†ºÂºè
            // GIFÂíåPNGÁ≠â‰øùÁïôÂéüÂßãÊ†ºÂºèÁâπÊÄßÔºàÂ¶ÇÂä®ÁîªÂíåÈÄèÊòéÂ∫¶Ôºâ
            if (mimeType === 'image/gif') {
                console.log('Ê£ÄÊµãÂà∞GIFÊ†ºÂºèÔºåË∑≥ËøáÂéãÁº©‰ª•‰øùÁïôÂä®ÁîªÊïàÊûú');
                return img.src; // ‰øùÁïôÂéüÂßãÊ†ºÂºè
            }
            
            // ÂØπ‰∫éPNGÂõæÁâáÔºåÂ¶ÇÊûúÈúÄË¶Å‰øùÁïôÈÄèÊòéÂ∫¶Ôºå‰ΩøÁî®Êõ¥È´òÁöÑË¥®Èáè
            let quality = 0.7; // ÈªòËÆ§Ë¥®Èáè
            let targetMimeType = mimeType;
            
            if (mimeType === 'image/png' || mimeType === 'image/webp') {
                // Ê£ÄÊü•ÊòØÂê¶ÊúâÈÄèÊòéÂ∫¶
                const hasTransparency = checkImageTransparency(img);
                if (hasTransparency) {
                    console.log('Ê£ÄÊµãÂà∞ÈÄèÊòéÂõæÁâáÔºå‰ΩøÁî®Êõ¥È´òË¥®ÈáèÂíåÂÖºÂÆπÊ†ºÂºè');
                    quality = 0.9; // ÊèêÈ´òË¥®Èáè‰øùÁïôÈÄèÊòéÊïàÊûú
                } else {
                    // Â¶ÇÊûúÊ≤°ÊúâÈÄèÊòéÂ∫¶ÔºåÂèØ‰ª•ËΩ¨‰∏∫JPEG‰ª•Ëé∑ÂæóÊõ¥Â•ΩÁöÑÂéãÁº©ÊïàÊûú
                    console.log('PNG/WebPÂõæÁâáÊó†ÈÄèÊòéÂ∫¶ÔºåËÄÉËôëËΩ¨Êç¢‰∏∫JPEG‰ª•ÊèêÈ´òÂéãÁº©ÊïàÁéá');
                    targetMimeType = 'image/jpeg';
                }
            }
            
            // ËÆ°ÁÆóÂéãÁº©ÂêéÁöÑÂ∞∫ÂØ∏Ôºå‰øùÊåÅÁ∫µÊ®™ÊØî
            const maxWidth = 1600;
            const maxHeight = 1600;
            let width = img.width;
            let height = img.height;
            
            // ‰ªÖÂΩìÂéüÂßãÂ∞∫ÂØ∏Ë∂ÖËøáÈôêÂà∂Êó∂ÊâçÁº©Â∞è
            if (width > maxWidth || height > maxHeight) {
                if (width > height) {
                    if (width > maxWidth) {
                        height = Math.round((height * maxWidth) / width);
                        width = maxWidth;
                    }
                } else {
                    if (height > maxHeight) {
                        width = Math.round((width * maxHeight) / height);
                        height = maxHeight;
                    }
                }
                console.log('ÂéãÁº©ÂêéÂõæÁâáÂ∞∫ÂØ∏:', width, 'x', height);
            } else {
                console.log('ÂõæÁâáÂ∞∫ÂØ∏Âú®ÂêàÁêÜËåÉÂõ¥ÂÜÖÔºå‰øùÊåÅÂéüÂßãÂ∞∫ÂØ∏');
            }
            
            try {
                // ÂàõÂª∫CanvasËøõË°åÂéãÁº©
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                
                // ÂØπJPEGËøõË°åÁôΩËâ≤ËÉåÊôØÂ°´ÂÖÖ
                if (targetMimeType === 'image/jpeg') {
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, width, height);
                }
                
                // ÁªòÂà∂ÂõæÁâá
                ctx.drawImage(img, 0, 0, width, height);
                
                // ËΩ¨Êç¢‰∏∫DataURLÔºåÈÄâÊã©ÂéãÁº©Ë¥®Èáè
                const compressedDataUrl = canvas.toDataURL(targetMimeType, quality);
                
                // Ê£ÄÊü•ÂéãÁº©ÁªìÊûú
                const originalSize = Math.round(img.src.length / 1024 / 1024 * 0.75);
                const compressedSize = Math.round(compressedDataUrl.length / 1024 / 1024 * 0.75);
                console.log('ÂéüÂßãÂõæÁâáÂ§ßÂ∞èÁ∫¶:', originalSize, 'MB');
                console.log('ÂéãÁº©ÂêéÂõæÁâáÂ§ßÂ∞èÁ∫¶:', compressedSize, 'MB');
                
                // Â¶ÇÊûúÂéãÁº©ÂêéÂèçËÄåÂèòÂ§ßÔºåËøîÂõûÂéüÂßãÂõæÁâá
                if (compressedSize > originalSize * 1.1) { // Â¶ÇÊûúÂ§ß‰∫éÂéüÂßãÂ§ß1.1ÂÄç
                    console.warn('ÂéãÁº©ÂêéÂõæÁâáÂ§ßÂ∞èÂ¢ûÂä†Ôºå‰ΩøÁî®ÂéüÂßãÂõæÁâá');
                    return img.src;
                }
                
                return compressedDataUrl;
            } catch (error) {
                console.error('ÂéãÁº©ÂõæÁâáÊó∂Âá∫Èîô:', error);
                // Âá∫ÈîôÊó∂ËøîÂõûÂéüÂßãÂõæÁâá
                return img.src;
            }
        }

        // Ê£ÄÊü•ÂõæÁâáÊòØÂê¶ÊúâÈÄèÊòéÂ∫¶
        function checkImageTransparency(img) {
            try {
                // ÂàõÂª∫‰∏¥Êó∂canvas
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // ‰ΩøÁî®Â∞èÂ∞∫ÂØ∏ÊèêÈ´òÊÄßËÉΩ
                const size = Math.min(50, img.width, img.height);
                canvas.width = size;
                canvas.height = size;
                
                // ÁªòÂà∂ÂõæÁâá
                ctx.drawImage(img, 0, 0, size, size);
                
                // Ëé∑ÂèñÂÉèÁ¥†Êï∞ÊçÆ
                const imageData = ctx.getImageData(0, 0, size, size).data;
                
                // Ê£ÄÊü•ÊòØÂê¶Â≠òÂú®ÈùûÂÆåÂÖ®‰∏çÈÄèÊòéÁöÑÂÉèÁ¥†
                for (let i = 3; i < imageData.length; i += 4) {
                    if (imageData[i] < 255) { // alphaÂÄºÂ∞è‰∫é255Ë°®Á§∫ÊúâÈÄèÊòéÂ∫¶
                        return true;
                    }
                }
                
                return false;
            } catch (error) {
                console.error('Ê£ÄÊü•ÂõæÁâáÈÄèÊòéÂ∫¶Êó∂Âá∫Èîô:', error);
                // Â¶ÇÊûúÂá∫ÈîôÔºåÂÆâÂÖ®Ëµ∑ËßÅÂÅáËÆæÊúâÈÄèÊòéÂ∫¶
                return true;
            }
        }
        
        // Â∞ÜÁÖßÁâá‰∏ä‰º†Âà∞Firebase
        function uploadPhotoToFirebase(photoData, retryCount = 0) {
            console.log('ÂºÄÂßã‰∏ä‰º†ÁÖßÁâáÂà∞Firebase, ÁÖßÁâáID:', photoData.id, retryCount > 0 ? `(ÈáçËØïÁ¨¨${retryCount}Ê¨°)` : '');
            
            // ÊúÄÂ§ßÈáçËØïÊ¨°Êï∞
            const MAX_RETRIES = 3;
            // ÂΩìÂâçÂ∑≤ÁªèË∂ÖËøáÈáçËØïÊ¨°Êï∞
            if (retryCount > MAX_RETRIES) {
                console.error(`‰∏ä‰º†Â§±Ë¥•ÔºåÂ∑≤Ë∂ÖËøáÊúÄÂ§ßÈáçËØïÊ¨°Êï∞(${MAX_RETRIES}Ê¨°)`);
                alert('ÁÖßÁâá‰∏ä‰º†Â§±Ë¥•ÔºåÂ∑≤Ëá™Âä®‰øùÂ≠òÂà∞Êú¨Âú∞ÔºåÁ®çÂêéÂ∞ÜËá™Âä®ÈáçËØïÂêåÊ≠•„ÄÇ');
                return;
            }
            
            try {
                // ÂÖà‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®ÔºåÁ°Æ‰øùÁÖßÁâáÁ´ãÂç≥ÊòæÁ§∫
                savePhotoToLocalStorage(photoData);
                console.log('ÁÖßÁâáÂ∑≤‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®');
                
                // Â¶ÇÊûúÊú™ÁôªÂΩïÔºåÂè™‰øùÂ≠òÂà∞Êú¨Âú∞
                if (!auth.currentUser) {
                    console.log('Êú™ÁôªÂΩïÔºåÁÖßÁâáÂè™‰øùÂ≠òÂú®Êú¨Âú∞');
                    return;
                }
                console.log('Â∑≤ÁôªÂΩïÔºåÁî®Êà∑ID:', auth.currentUser.uid);

                // ÂàõÂª∫Timeout‰ª•Èò≤Ê≠¢Ë∂ÖÊó∂
                let uploadTimeout;
                const UPLOAD_TIMEOUT = 60000; // 60ÁßíË∂ÖÊó∂
                
                // Â∞Übase64ËΩ¨Êç¢‰∏∫Blob
                let imageBlob;
                try {
                    imageBlob = dataURItoBlob(photoData.src);
                    console.log('Â∑≤Â∞ÜÂõæÁâáËΩ¨Êç¢‰∏∫Blob, Â§ßÂ∞è:', imageBlob.size, 'bytes');
                } catch (error) {
                    console.error('ÂõæÁâáËΩ¨Êç¢Â§±Ë¥•:', error);
                    // ÂõæÁâáÊ†ºÂºèÈóÆÈ¢òÔºå‰∏çÈáçËØï
                    alert('ÂõæÁâáÊ†ºÂºèÊó†ÊïàÔºåËØ∑ÈÄâÊã©ÂÖ∂‰ªñÂõæÁâá„ÄÇ');
                    return;
                }
                
                // ÂàõÂª∫StorageÂºïÁî®
                const storageRef = storage.ref(`photos/${photoData.id}`);
                console.log('ÂàõÂª∫ Storage ÂºïÁî®:', `photos/${photoData.id}`);
                
                // ËÆæÁΩÆËá™ÂÆö‰πâÂÖÉÊï∞ÊçÆ‰ª•ÊèêÈ´òÊàêÂäüÁéá
                const metadata = {
                    contentType: imageBlob.type,
                    customMetadata: {
                        'originalName': photoData.name,
                        'uploadTime': new Date().toISOString(),
                        'fileSize': imageBlob.size.toString(),
                        'deviceInfo': navigator.userAgent
                    }
                };
                
                // Ê∏ÖÈô§‰πãÂâçÁöÑË∂ÖÊó∂
                clearTimeout(uploadTimeout);
                
                // ËÆæÁΩÆÊñ∞ÁöÑË∂ÖÊó∂
                uploadTimeout = setTimeout(() => {
                    console.warn(`‰∏ä‰º†Ë∂ÖÊó∂(${UPLOAD_TIMEOUT / 1000}s)ÔºåÂ∞ÜËá™Âä®ÈáçËØï`);
                    // ÈáçËØï‰∏ä‰º†
                    uploadPhotoToFirebase(photoData, retryCount + 1);
                }, UPLOAD_TIMEOUT);
                
                // Âà§Êñ≠ÊòØÂê¶ÈúÄË¶Å‰ΩøÁî®ÂàÜÂùó‰∏ä‰º†
                const CHUNK_THRESHOLD = 2 * 1024 * 1024; // 2MB‰ª•‰∏ä‰ΩøÁî®ÂàÜÂùó‰∏ä‰º†
                let uploadTask;
                
                if (imageBlob.size > CHUNK_THRESHOLD) {
                    console.log('ÂõæÁâáÂ§ßÂ∞èË∂ÖËøá', (CHUNK_THRESHOLD / 1024 / 1024), 'MB, Â∞ùËØï‰ΩøÁî®Êõ¥ÂèØÈù†ÁöÑ‰∏ä‰º†ÊñπÂºè');
                    
                    try {
                        // ÂØπ‰∫éÂ§ßÊñá‰ª∂ÔºåÊàë‰ª¨Â∞ùËØïÂÖàÂºÄÂßã‰∏ä‰º†ÔºåÁÑ∂ÂêéËøõË°åÊöÇÂÅúÂíåÊÅ¢Â§çÊ®°Êãü
                        uploadTask = storageRef.put(imageBlob, metadata);
                        console.log('ÂºÄÂßã‰∏ä‰º†Â§ßÂûãÁÖßÁâáÂà∞ Storage...', 'Â§ßÂ∞è:', (imageBlob.size / 1024 / 1024).toFixed(2), 'MB');
                    } catch (error) {
                        console.error('ÂàõÂª∫Storage‰∏ä‰º†‰ªªÂä°Â§±Ë¥•:', error);
                        // Â¶ÇÊûúÂàõÂª∫uploadTaskÂ§±Ë¥•ÔºåÂ∞ùËØïÊõ¥ÁÆÄÂçïÁöÑÊñπÂºè
                        try {
                            console.log('Â∞ùËØï‰ΩøÁî®Â§áÁî®‰∏ä‰º†ÊñπÂºè');
                            uploadTask = storageRef.put(imageBlob);
                        } catch (e) {
                            console.error('Â§áÁî®‰∏ä‰º†ÊñπÂºè‰πüÂ§±Ë¥•:', e);
                            throw e; // ÈáçÊñ∞ÊäõÂá∫‰ª•ËøõÂÖ•ÈîôËØØÂ§ÑÁêÜ
                        }
                    }
                } else {
                    // ÂØπ‰∫éÂ∞èÊñá‰ª∂ÔºåÁõ¥Êé•‰ΩøÁî®Ê†áÂáÜ‰∏ä‰º†
                    uploadTask = storageRef.put(imageBlob, metadata);
                    console.log('ÂºÄÂßã‰∏ä‰º†ÁÖßÁâáÂà∞ Storage...', 'Â§ßÂ∞è:', (imageBlob.size / 1024 / 1024).toFixed(2), 'MB');
                }
                
                // ‰∏ä‰º†Êñ≠ÁÇπÁª≠‰º†
                uploadTask.on('state_changed', 
                    // ËøõÂ∫¶ÂõûË∞É
                    (snapshot) => {
                        try {
                            // ÊØèÊ¨°ËøõÂ∫¶Êõ¥Êñ∞Êó∂ÈáçÁΩÆË∂ÖÊó∂ËÆ°Êó∂Âô®
                            clearTimeout(uploadTimeout);
                            
                            // Êõ¥Êñ∞‰∏ä‰º†ËøõÂ∫¶
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            console.log('‰∏ä‰º†ËøõÂ∫¶: ' + progress.toFixed(2) + '%');
                            
                            // ÊØèÈó¥10%ËøõÂ∫¶ËÆ∞ÂΩïËØ¶ÁªÜ‰ø°ÊÅØ
                            if (Math.floor(progress) % 10 === 0) {
                                console.log(`‰∏ä‰º†ËøõÂ∫¶Èáè: ${snapshot.bytesTransferred} / ${snapshot.totalBytes} Â≠óËäÇ`);
                            }
                            
                            // ËÆæÁΩÆË∂ÖÊó∂ËÆ°Êó∂Âô®
                            uploadTimeout = setTimeout(() => {
                                console.warn(`‰∏ä‰º†Ë∂ÖÊó∂(${UPLOAD_TIMEOUT / 1000}s)ÔºåÂ∞ÜËá™Âä®ÈáçËØï`);
                                try {
                                    // Âú®Ë∂ÖÊó∂ÂâçÂ∞ùËØïÂèñÊ∂à‰∏ä‰º†
                                    uploadTask.cancel().then(() => {
                                        console.log('Ë∂ÖÊó∂‰∏ä‰º†ÊàêÂäüÂèñÊ∂à');
                                        // ÈáçËØï‰∏ä‰º†
                                        uploadPhotoToFirebase(photoData, retryCount + 1);
                                    }).catch(err => {
                                        console.error('ÂèñÊ∂àË∂ÖÊó∂‰∏ä‰º†Â§±Ë¥•:', err);
                                        // ‰ªçÁÑ∂ÈáçËØï‰∏ä‰º†
                                        uploadPhotoToFirebase(photoData, retryCount + 1);
                                    });
                                } catch (cancelError) {
                                    console.error('ÂèñÊ∂à‰∏ä‰º†Êó∂Âá∫Èîô:', cancelError);
                                    // Áõ¥Êé•ÈáçËØï‰∏ä‰º†
                                    uploadPhotoToFirebase(photoData, retryCount + 1);
                                }
                            }, UPLOAD_TIMEOUT);
                            
                            // Â¶ÇÊûúËøõÂ∫¶Â§ß‰∫é90%ÔºåÂª∂ÈïøË∂ÖÊó∂Êó∂Èó¥
                            if (progress > 90 && uploadTimeout) {
                                clearTimeout(uploadTimeout);
                                // Âª∂ÈïøË∂ÖÊó∂Êó∂Èó¥ÁªôÂç≥Â∞ÜÂÆåÊàêÁöÑ‰∏ä‰º†
                                uploadTimeout = setTimeout(() => {
                                    console.warn('Â∞ΩÁÆ°‰∏ä‰º†ËøõÂ∫¶Ë∂ÖËøá90%Ôºå‰ΩÜ‰ªçÁÑ∂Ë∂ÖÊó∂ÔºåÂ∞ùËØïÂèñÊ∂àÂπ∂ÈáçËØï');
                                    try {
                                        uploadTask.cancel();
                                    } catch (e) {
                                        console.error('ÂèñÊ∂à‰∏ä‰º†Â§±Ë¥•:', e);
                                    }
                                    uploadPhotoToFirebase(photoData, retryCount + 1);
                                }, 30000); // 30ÁßíË∂ÖÊó∂
                            }
                            
                            // ËÆ∞ÂΩïÂΩìÂâçÁä∂ÊÄÅ
                            switch (snapshot.state) {
                                case 'paused':
                                    console.log('‰∏ä‰º†Â∑≤ÊöÇÂÅú');
                                    break;
                                case 'running':
                                    console.log('‰∏ä‰º†Ê≠£Âú®ËøõË°å');
                                    break;
                            }
                        } catch (progressError) {
                            console.error('Â§ÑÁêÜ‰∏ä‰º†ËøõÂ∫¶Êó∂Âá∫Èîô:', progressError);
                        }
                    },
                    // ÈîôËØØÂõûË∞É
                    (error) => {
                        // Ê∏ÖÈô§Ë∂ÖÊó∂ËÆ°Êó∂Âô®
                        clearTimeout(uploadTimeout);
                        console.error('‰∏ä‰º†Â§±Ë¥•:', error.code, error.message);
                        
                        // Ê†πÊçÆÈîôËØØÁ±ªÂûãÂÜ≥ÂÆöÊòØÂê¶ÈúÄË¶ÅÈáçËØï
                        if (retryCount < MAX_RETRIES) {
                            // Êâ©Â±ïÂèØÈáçËØïÁöÑÈîôËØØÁ±ªÂûã
                            const retryableErrors = [
                                'storage/server-error', 
                                'storage/retry-limit-exceeded',
                                'storage/network-error',
                                'storage/unknown',
                                'storage/quota-exceeded',
                                'storage/timeout',
                                'storage/canceled',
                                'storage/invalid-url'
                            ];
                            
                            if (retryableErrors.includes(error.code) || !error.code) {
                                // Ê†πÊçÆÈáçËØïÊ¨°Êï∞Â¢ûÂä†Âª∂Ëøü
                                const retryDelayWithBackoff = RETRY_DELAY * Math.pow(2, retryCount);
                                console.log(`Â∞ÜÂú®${retryDelayWithBackoff/1000}ÁßíÂêéËøõË°åÁ¨¨${retryCount + 1}Ê¨°ÈáçËØï...`);
                                
                                setTimeout(() => {
                                    try {
                                        // ÈáçËØïÂâçÂ∞ùËØïÊ£ÄÊü•ÁΩëÁªúÁä∂ÊÄÅ
                                        if (!navigator.onLine) {
                                            console.warn('ËÆæÂ§áÁ¶ªÁ∫øÔºåÁ≠âÂæÖÁΩëÁªúÊÅ¢Â§çÂêéÈáçËØï');
                                            // ÁõëÂê¨ÁΩëÁªúÊÅ¢Â§ç‰∫ã‰ª∂
                                            window.addEventListener('online', function onlineHandler() {
                                                window.removeEventListener('online', onlineHandler);
                                                console.log('ÁΩëÁªúÂ∑≤ÊÅ¢Â§çÔºåÂ∞ùËØïÈáçÊñ∞‰∏ä‰º†');
                                                uploadPhotoToFirebase(photoData, retryCount + 1);
                                            });
                                        } else {
                                            uploadPhotoToFirebase(photoData, retryCount + 1);
                                        }
                                    } catch (e) {
                                        console.error('ÈáçËØïÂáÜÂ§áËøáÁ®ã‰∏≠Âá∫Èîô:', e);
                                        uploadPhotoToFirebase(photoData, retryCount + 1);
                                    }
                                }, retryDelayWithBackoff);
                            } else {
                                // ÂÖ∂‰ªñÈîôËØØ‰∏çÈúÄË¶ÅÈáçËØïÔºåÂ¶ÇÊùÉÈôê‰∏çË∂≥ÊàñÂèñÊ∂àÁ≠â
                                console.error('‰∏çÂèØÈáçËØïÁöÑÈîôËØØÁ±ªÂûã:', error.code);
                                alert(`‰∏ä‰º†Â§±Ë¥•: ${error.message}\nÈîôËØØÁ±ªÂûã: ${error.code}`);
                            }
                        } else {
                            alert(`Â∑≤Â∞ùËØï${MAX_RETRIES}Ê¨°‰∏ä‰º†Ôºå‰ΩÜ‰ªçÁÑ∂Â§±Ë¥•„ÄÇËØ∑Á®çÂêéÂÜçËØï„ÄÇ`);
                        }
                    },
                    // ÊàêÂäüÂõûË∞É
                    () => {
                        // Ê∏ÖÈô§Ë∂ÖÊó∂ËÆ°Êó∂Âô®
                        clearTimeout(uploadTimeout);
                        
                        // ‰∏ä‰º†ÂÆåÊàêÔºåËé∑Âèñ‰∏ãËΩΩÈìæÊé•
                        console.log('ÁÖßÁâá‰∏ä‰º†ÂÆåÊàêÔºåÊ≠£Âú®Ëé∑Âèñ‰∏ãËΩΩ URL...');
                        uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                            console.log('ÂõæÁâáÂèØÂú®‰ª•‰∏ãÂú∞ÂùÄËÆøÈóÆ:', downloadURL);
                            
                            // ‰øùÂ≠òÁÖßÁâáÊï∞ÊçÆÂà∞Firestore
                            console.log('ÂáÜÂ§á‰øùÂ≠òÁÖßÁâáÊï∞ÊçÆÂà∞ Firestore...');
                            const photoToSave = {
                                id: photoData.id,
                                name: photoData.name,
                                src: downloadURL,
                                date: firebase.firestore.Timestamp.fromDate(new Date(photoData.date)),
                                memory: photoData.memory || ''
                            };
                            console.log('Ë¶Å‰øùÂ≠òÁöÑÁÖßÁâáÊï∞ÊçÆ:', photoToSave);
                            
                            // ËÆæÁΩÆFirestoreÂÜôÂÖ•Ë∂ÖÊó∂
                            const firestoreTimeout = setTimeout(() => {
                                console.warn('‰øùÂ≠òÂà∞FirestoreË∂ÖÊó∂ÔºåÂ∞ÜÊõ¥Êñ∞Êú¨Âú∞ÁÖßÁâáURL');
                                // Êõ¥Êñ∞Êú¨Âú∞ÁÖßÁâáURL
                                updateLocalPhotoUrl(photoData.id, downloadURL);
                            }, 20000); // 20ÁßíË∂ÖÊó∂
                            
                            photosCollection.doc(photoData.id.toString()).set(photoToSave)
                                .then(() => {
                                    clearTimeout(firestoreTimeout); // Ê∏ÖÈô§Ë∂ÖÊó∂
                                    console.log("ÁÖßÁâáÊï∞ÊçÆ‰øùÂ≠òÊàêÂäü! ID:", photoData.id);
                                    // Êõ¥Êñ∞Êú¨Âú∞ÁÖßÁâáURL
                                    updateLocalPhotoUrl(photoData.id, downloadURL);
                                })
                                .catch(error => {
                                    clearTimeout(firestoreTimeout); // Ê∏ÖÈô§Ë∂ÖÊó∂
                                    console.error("‰øùÂ≠òÁÖßÁâáÊï∞ÊçÆÂ§±Ë¥•:", error);
                                    console.error('ÈîôËØØ‰ª£Á†Å:', error.code);
                                    console.error('ÈîôËØØ‰ø°ÊÅØ:', error.message);
                                    // Â∞ùËØïÈáçËØïFirestoreÂÜôÂÖ•
                                    if (retryCount < MAX_RETRIES) {
                                        const nextRetryCount = retryCount + 1;
                                        console.log(`Â∞ÜÂºÄÂßãÁ¨¨ ${nextRetryCount} Ê¨°FirestoreÂÜôÂÖ•ÈáçËØï`);
                                        setTimeout(() => {
                                            console.log('ÈáçÊñ∞Â∞ùËØï‰øùÂ≠òÂà∞Firestore...');
                                            const photoToRetrySave = {
                                                id: photoData.id,
                                                name: photoData.name,
                                                src: downloadURL,
                                                date: firebase.firestore.Timestamp.fromDate(new Date(photoData.date)),
                                                memory: photoData.memory || ''
                                            };
                                            console.log('ÈáçËØïË¶Å‰øùÂ≠òÁöÑÁÖßÁâáÊï∞ÊçÆ:', photoToRetrySave);
                            
                                            // ËÆæÁΩÆFirestoreÂÜôÂÖ•ÈáçËØïË∂ÖÊó∂
                                            const retryFirestoreTimeout = setTimeout(() => {
                                                console.warn('ÈáçËØï‰øùÂ≠òÂà∞FirestoreË∂ÖÊó∂ÔºåÂ∞ÜÊõ¥Êñ∞Êú¨Âú∞ÁÖßÁâáURL');
                                                // Êõ¥Êñ∞Êú¨Âú∞ÁÖßÁâáURL
                                                updateLocalPhotoUrl(photoData.id, downloadURL);
                                            }, 20000); // 20ÁßíË∂ÖÊó∂
                            
                                            photosCollection.doc(photoData.id.toString()).set(photoToRetrySave)
                                                .then(() => {
                                                    clearTimeout(retryFirestoreTimeout); // Ê∏ÖÈô§Ë∂ÖÊó∂
                                                    console.log('ÈáçËØï‰øùÂ≠òÊàêÂäü! ID:', photoData.id);
                                                    // Êõ¥Êñ∞Êú¨Âú∞ÁÖßÁâáURL
                                                    updateLocalPhotoUrl(photoData.id, downloadURL);
                                                })
                                                .catch(err => {
                                                    clearTimeout(retryFirestoreTimeout); // Ê∏ÖÈô§Ë∂ÖÊó∂
                                                    console.error('ÈáçËØï‰øùÂ≠ò‰ªçÁÑ∂Â§±Ë¥•:', err);
                                                    // ‰ªçÁÑ∂Êõ¥Êñ∞Êú¨Âú∞URL
                                                    updateLocalPhotoUrl(photoData.id, downloadURL);
                                                });
                                        }, 3000);
                                    } else {
                                        // Ë∂ÖËøáÈáçËØïÊ¨°Êï∞Ôºå‰ΩÜ‰ªçÊõ¥Êñ∞Êú¨Âú∞URL
                                        updateLocalPhotoUrl(photoData.id, downloadURL);
                                    }
                                })
                        }).catch(error => {
                            console.error('Ëé∑Âèñ‰∏ãËΩΩÈìæÊé•Â§±Ë¥•:', error);
                            console.error('ÈîôËØØ‰ª£Á†Å:', error.code);
                            console.error('ÈîôËØØ‰ø°ÊÅØ:', error.message);
                            
                            // ÈáçËØïËé∑Âèñ‰∏ãËΩΩÈìæÊé•
                            if (retryCount < MAX_RETRIES) {
                                setTimeout(() => {
                                    console.log('ÈáçÊñ∞Â∞ùËØïËé∑Âèñ‰∏ãËΩΩÈìæÊé•...');
                                    uploadTask.snapshot.ref.getDownloadURL()
                                        .then(url => {
                                            console.log('ÈáçËØïËé∑ÂèñÈìæÊé•ÊàêÂäü:', url);
                                            // Êõ¥Êñ∞Êú¨Âú∞ÂõæÁâáÈìæÊé•
                                            updateLocalPhotoUrl(photoData.id, url);
                                        })
                                        .catch(err => {
                                            console.error('ÈáçËØïËé∑ÂèñÈìæÊé•‰ªçÁÑ∂Â§±Ë¥•:', err);
                                        });
                                }, 3000);
                            }
                            // Âç≥‰ΩøÊó†Ê≥ïËé∑ÂèñÈìæÊé•Ôºå‰ªçÁÑ∂Êõ¥Êñ∞Êú¨Âú∞ÂõæÁâá
                            console.log('Â∞Ü‰ΩøÁî®ÂéüÂßãÁÖßÁâáÊòæÁ§∫');
                        });
                    }
                );
            } catch (error) {
                console.error('‰∏ä‰º†ËøáÁ®ãÂèëÁîüÈîôËØØ:', error);
                // Â¶ÇÊûúÂèëÁîüÂºÇÂ∏∏Ôºå‰ªçÁÑ∂ÊòæÁ§∫ÁÖßÁâáÔºà‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩÔºâ
                loadPhotosFromLocalStorage();
                
                // ÈáçËØï‰∏ä‰º†
                if (retryCount < MAX_RETRIES) {
                    setTimeout(() => {
                        console.log(`ÂèëÁîüÂºÇÂ∏∏ÔºåÂ∞ÜÂú® 5 ÁßíÂêéÈáçËØï‰∏ä‰º†(Á¨¨ ${retryCount + 1} Ê¨°)`);
                        uploadPhotoToFirebase(photoData, retryCount + 1);
                    }, 5000); // 5ÁßíÂêéÈáçËØï
                }
            }
        }

// Êõ¥Êñ∞Êú¨Âú∞ÁÖßÁâáURL
function updateLocalPhotoUrl(photoId, newUrl) {
    console.log('Êõ¥Êñ∞Êú¨Âú∞ÁÖßÁâáURL, ID:', photoId);
    const photoIndex = photos.findIndex(p => p.id === photoId);
    if (photoIndex !== -1) {
        // Êõ¥Êñ∞URL
        photos[photoIndex].src = newUrl;
        // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
        localStorage.setItem('photos', JSON.stringify(photos));
        console.log('Êú¨Âú∞ÁÖßÁâáURLÊõ¥Êñ∞ÊàêÂäü');
        // ÈáçÊñ∞Ê∏≤ÊüìÁÖßÁâá
        sortAndDisplayPhotos();
    } else {
        console.error('Êú™ÊâæÂà∞Ë¶ÅÊõ¥Êñ∞URLÁöÑÁÖßÁâá:', photoId);
    }
}
        
        // Â∞Übase64ËΩ¨Êç¢‰∏∫Blob
        function dataURItoBlob(dataURI) {
            console.log('ÂºÄÂßãËΩ¨Êç¢base64‰∏∫Blob...');
            try {
                // È™åËØÅÊòØÂê¶ÊòØÊúâÊïàÁöÑdata URI
                if (!dataURI || typeof dataURI !== 'string' || !dataURI.includes('data:')) {
                    console.error('Êó†ÊïàÁöÑdata URIÊ†ºÂºè');
                    throw new Error('Êó†ÊïàÁöÑÂõæÁâáÊ†ºÂºè');
                }
                
                // ÊèêÂèñMIMEÁ±ªÂûãÂíåbase64Êï∞ÊçÆ
                const parts = dataURI.split(',');
                if (parts.length !== 2) {
                    console.error('data URIÊ†ºÂºèÈîôËØØ: ‰∏çË∂≥‰∏§ÈÉ®ÂàÜ');
                    throw new Error('data URIÊ†ºÂºèÈîôËØØ');
                }
                
                const mimeMatch = parts[0].match(/:(.*?);/);
                if (!mimeMatch || mimeMatch.length < 2) {
                    console.error('data URIÊ†ºÂºèÈîôËØØ: Êó†Ê≥ïÊèêÂèñMIMEÁ±ªÂûã');
                    throw new Error('Êó†Ê≥ïÊèêÂèñÂõæÁâáÁ±ªÂûã');
                }
                
                const mimeString = mimeMatch[1];
                console.log('ÂõæÁâáMIMEÁ±ªÂûã:', mimeString);
                
                // Ëß£Á†Åbase64
                let byteString;
                try {
                    byteString = atob(parts[1]);
                } catch (e) {
                    console.error('base64Ëß£Á†ÅÂ§±Ë¥•:', e);
                    throw new Error('base64Ëß£Á†ÅÂ§±Ë¥•');
                }
                
                // ÂàõÂª∫ArrayBufferÂíåUint8Array
                const ab = new ArrayBuffer(byteString.length);
                const ia = new Uint8Array(ab);
                
                for (let i = 0; i < byteString.length; i++) {
                    ia[i] = byteString.charCodeAt(i);
                }
                
                // ÂàõÂª∫BlobÂØπË±°
                const blob = new Blob([ab], {type: mimeString});
                console.log('ËΩ¨Êç¢ÊàêÂäü, BlobÂ§ßÂ∞è:', blob.size, 'bytes, Á±ªÂûã:', blob.type);
                return blob;
            } catch (error) {
                console.error('Â∞Übase64ËΩ¨Êç¢‰∏∫BlobÊó∂Âá∫Èîô:', error);
                throw error; // Â∞ÜÈîôËØØÂêë‰∏äÊäõÂá∫Ôºå‰æø‰∫éË∞ÉÁî®Â§ÑÊçïËé∑
            }
        }
        
        // ‰øùÂ≠òÁÖßÁâáÂà∞Êú¨Âú∞Â≠òÂÇ®
        function savePhotoToLocalStorage(photoData) {
            let savedToLocalStorageSuccess = false;
            try {
                // Ëé∑ÂèñÂΩìÂâçÂ≠òÂÇ®ÁöÑÁÖßÁâá
                let storedPhotos = JSON.parse(localStorage.getItem('photos') || '[]');
                
                // Ê∑ªÂä†Êñ∞ÁÖßÁâá
                storedPhotos.push(photoData);
                
                // ‰øùÂ≠òÂõûÊú¨Âú∞Â≠òÂÇ®
                localStorage.setItem('photos', JSON.stringify(storedPhotos));
                savedToLocalStorageSuccess = true;
                console.log('ÁÖßÁâáÂ∑≤‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®');
            } catch (error) {
                console.error('‰øùÂ≠òÁÖßÁâáÂà∞Êú¨Âú∞Â≠òÂÇ®Â§±Ë¥• (QuotaExceededErrorÂæàÂèØËÉΩÂèëÁîü):', error);
                // Âç≥‰Ωø‰øùÂ≠òÂà∞LocalStorageÂ§±Ë¥•ÔºåÊàë‰ª¨‰ªçÁÑ∂Â∏åÊúõÂú®UI‰∏äÊòæÁ§∫ÂÆÉ
                // ÂêéÁª≠ÁöÑFirebase‰∏ä‰º†‰ºöË¥üË¥£ÊåÅ‰πÖÂåñÂ≠òÂÇ®
            }

            // Êó†ËÆ∫LocalStorageÊòØÂê¶‰øùÂ≠òÊàêÂäüÔºåÈÉΩÊõ¥Êñ∞ÂÜÖÂ≠ò‰∏≠ÁöÑÁÖßÁâáÊï∞ÁªÑÂπ∂ÊòæÁ§∫
            // ËøôÊ†∑Áî®Êà∑ÂèØ‰ª•Á´ãÂç≥ÁúãÂà∞‰∏ä‰º†ÁöÑÂõæÁâá
            const photoExistsInMemory = photos.some(p => p.id === photoData.id);
            if (!photoExistsInMemory) {
                photos.push(photoData);
            }
            sortAndDisplayPhotos();
            
            if (!savedToLocalStorageSuccess) {
                // ÂèØ‰ª•ÈÄâÊã©ÊÄßÂú∞ÁªôÁî®Êà∑‰∏Ä‰∏™ÊèêÁ§∫ÔºåÂëäÁü•ÂõæÁâáÂèØËÉΩÊú™ÂÆåÂÖ®Âú®Êú¨Âú∞ÁºìÂ≠ò
                // console.warn('ÊèêÁ§∫: ÁÖßÁâáÊú™ËÉΩÂÆåÊï¥ÁºìÂ≠òÂú®Êú¨Âú∞Ôºå‰ΩÜ‰ºöÂ∞ùËØï‰∏ä‰º†Âà∞‰∫ëÁ´Ø„ÄÇ');
            }
        }
        
        // ‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩÁÖßÁâá
        function loadPhotosFromLocalStorage() {
            try {
                const storedPhotos = JSON.parse(localStorage.getItem('photos') || '[]');
                if (storedPhotos.length > 0) {
                    photos = storedPhotos.map(photo => {
                        // Á°Æ‰øùÊó•ÊúüÊòØDateÂØπË±°
                        return {
                            ...photo,
                            date: new Date(photo.date)
                        };
                    });
                    sortAndDisplayPhotos();
                    console.log('‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩ‰∫Ü', photos.length, 'Âº†ÁÖßÁâá');
                }
            } catch (error) {
                console.error('‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩÁÖßÁâáÂ§±Ë¥•:', error);
                photos = [];
                sortAndDisplayPhotos();
            }
        }
        
        // ÂêàÂπ∂Êú¨Âú∞ÂíåFirestoreÁÖßÁâá
        function mergePhotos(firebasePhotos) {
            console.log('ÂºÄÂßãÂêàÂπ∂Êú¨Âú∞ÂíåFirestoreÁÖßÁâá...');
            if (firebasePhotos.length > 0) {
                console.log('‰ªéFirestoreÂä†ËΩΩ‰∫Ü', firebasePhotos.length, 'Âº†ÁÖßÁâá');
                
                // Ëé∑ÂèñÊú¨Âú∞ÁÖßÁâá
                const localPhotos = JSON.parse(localStorage.getItem('photos') || '[]');
                console.log('Êú¨Âú∞Â≠òÂÇ®‰∏≠Êúâ', localPhotos.length, 'Âº†ÁÖßÁâá');
                const allPhotoIds = new Set();
                
                // ÂÖàÊ∑ªÂä†FirestoreÁÖßÁâá
                photos = firebasePhotos;
                firebasePhotos.forEach(photo => allPhotoIds.add(photo.id));
                
                // Ê∑ªÂä†Êú¨Âú∞Áã¨ÊúâÁöÑÁÖßÁâá
                let localOnlyCount = 0;
                localPhotos.forEach(photo => {
                    if (!allPhotoIds.has(photo.id)) {
                        console.log('ÂèëÁé∞Êú¨Âú∞Áã¨ÊúâÁÖßÁâá:', photo.id);
                        localOnlyCount++;
                        photos.push({
                            ...photo,
                            date: new Date(photo.date)
                        });
                        // Â∞ùËØïÂ∞ÜÊú¨Âú∞Áã¨ÊúâÁÖßÁâá‰πü‰∏ä‰º†Âà∞Firestore
                        uploadPhotoToFirebase(photo);
                    }
                });
                console.log('Ê∑ªÂä†‰∫Ü', localOnlyCount, 'Âº†Êú¨Âú∞Áã¨ÊúâÁÖßÁâá');
                
                // Êõ¥Êñ∞Êú¨Âú∞Â≠òÂÇ®
                localStorage.setItem('photos', JSON.stringify(photos));
                console.log('Â∑≤Êõ¥Êñ∞Êú¨Âú∞Â≠òÂÇ®, ÂêàËÆ°', photos.length, 'Âº†ÁÖßÁâá');
                
                // ÊéíÂ∫èÂπ∂ÊòæÁ§∫ÁÖßÁâá
                sortAndDisplayPhotos();
            } else {
                console.log('Firestore‰∏≠Ê≤°ÊúâÁÖßÁâáÔºå‰ΩøÁî®Êú¨Âú∞Â≠òÂÇ®');
                loadPhotosFromLocalStorage();
            }
        }
        
        // ‰ªéFirebaseÂä†ËΩΩÁÖßÁâá
        function loadPhotosFromFirebase() {
            console.log('ÂºÄÂßã‰ªéFirestoreÂä†ËΩΩÁÖßÁâá...');
            // Â∞ùËØï‰ΩøÁî®ÈÄöÁî®Êü•ËØ¢Ôºå‰∏ç‰æùËµñ‰∫éÁâπÂÆöÁî®Êà∑
            photosCollection.get()
                .then(snapshot => {
                    console.log('ÊàêÂäüËé∑ÂèñFirestoreÊï∞ÊçÆ, ÊñáÊ°£Êï∞:', snapshot.size);
                    const firebasePhotos = [];
                    snapshot.forEach(doc => {
                        const photoData = doc.data();
                        console.log('Â§ÑÁêÜÁÖßÁâáÊñáÊ°£:', doc.id, photoData);
                        firebasePhotos.push({
                            id: photoData.id,
                            name: photoData.name,
                            src: photoData.src,
                            date: photoData.date && photoData.date.toDate ? photoData.date.toDate() : new Date(photoData.date || Date.now()),
                            memory: photoData.memory || ''
                        });
                    });
                    
                    console.log('‰ªéFirestoreÂä†ËΩΩ‰∫Ü', firebasePhotos.length, 'Âº†ÁÖßÁâá');
                    if (firebasePhotos.length > 0) {
                        console.log('Á¨¨‰∏ÄÂº†ÁÖßÁâáÊ†∑‰æã:', firebasePhotos[0]);
                    }
                    
                    // ÂêàÂπ∂Êú¨Âú∞ÂíåFirebaseÁÖßÁâá
                    mergePhotos(firebasePhotos);
                    
                    // ËÆæÁΩÆÂÆûÊó∂ÁõëÂê¨
                    setupRealtimeListener();
                })
                .catch(error => {
                    console.error('‰ªéFirestoreÂä†ËΩΩÁÖßÁâáÂ§±Ë¥•:', error);
                    console.error('ÈîôËØØ‰ª£Á†Å:', error.code);
                    console.error('ÈîôËØØ‰ø°ÊÅØ:', error.message);
                    loadPhotosFromLocalStorage();
                });
}

// ËÆæÁΩÆÂÆûÊó∂Êï∞ÊçÆÁõëÂê¨
function setupRealtimeListener() {
    console.log('ËÆæÁΩÆ Firestore ÂÆûÊó∂ÁõëÂê¨Âô®...');
    console.log('‰ΩøÁî®ÂÖ±‰∫´ËÆøÈóÆËøõË°åÁõëÂê¨ÔºåËÆøÈóÆÂØÜÈí•:', sharedAccessKey);
            // ÂèñÊ∂à‰πãÂâçÁöÑÁõëÂê¨Âô®
            let unsubscribeAdded;
            
            // ÁõëÂê¨Êñ∞ÁÖßÁâáÊ∑ªÂä†ÂíåÊõ¥Êñ∞
            unsubscribeAdded = photosCollection.onSnapshot(snapshot => {
                console.log('Êî∂Âà∞ Firestore Êï∞ÊçÆÂèòÂåñ, ÂèòÂåñÊï∞:', snapshot.docChanges().length);
                
                snapshot.docChanges().forEach(change => {
                    console.log('ÂèòÂåñÁ±ªÂûã:', change.type, 'ÊñáÊ°£ID:', change.doc.id);
                    const photoData = change.doc.data();
                    console.log('ÁÖßÁâáÊï∞ÊçÆ:', photoData);
                    
                    if (change.type === 'added') {
                        // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®Ê≠§ÁÖßÁâá
                        const existingIndex = photos.findIndex(p => p.id === photoData.id);
                        console.log('Ê£ÄÊü•ÁÖßÁâáÊòØÂê¶Â≠òÂú®, ID:', photoData.id, 'Á¥¢Âºï:', existingIndex);
                        
                        if (existingIndex === -1) {
                            // Ê∑ªÂä†Êñ∞ÁÖßÁâá
                            const newPhoto = {
                                id: photoData.id,
                                name: photoData.name,
                                src: photoData.src,
                                date: photoData.date && photoData.date.toDate ? photoData.date.toDate() : new Date(photoData.date || Date.now()),
                                memory: photoData.memory || ''
                            };
                            photos.push(newPhoto);
                            console.log('Ê∑ªÂä†Êñ∞ÁÖßÁâáÂà∞Êï∞ÁªÑ:', newPhoto);
                            
                            // Êõ¥Êñ∞Êú¨Âú∞Â≠òÂÇ®
                            localStorage.setItem('photos', JSON.stringify(photos));
                            console.log('Â∑≤Êõ¥Êñ∞Êú¨Âú∞Â≠òÂÇ®, ÊÄªÁÖßÁâáÊï∞:', photos.length);
                            
                            // ÈáçÊñ∞ÊéíÂ∫èÂíåÊòæÁ§∫
                            sortAndDisplayPhotos();
                            console.log('Êñ∞ÁÖßÁâáÊ∑ªÂä†ÂÆåÊàê:', photoData.id);
                        }
                    }
                    
                    if (change.type === 'modified') {
                        // Êõ¥Êñ∞Â∑≤Â≠òÂú®ÁöÑÁÖßÁâá
                        const existingIndex = photos.findIndex(p => p.id === photoData.id);
                        console.log('Ê£ÄÊü•Ë¶ÅÊõ¥Êñ∞ÁöÑÁÖßÁâá, ID:', photoData.id, 'Á¥¢Âºï:', existingIndex);
                        
                        if (existingIndex !== -1) {
                            const updatedPhoto = {
                                id: photoData.id,
                                name: photoData.name,
                                src: photoData.src,
                                date: photoData.date && photoData.date.toDate ? photoData.date.toDate() : new Date(photoData.date || Date.now()),
                                memory: photoData.memory || ''
                            };
                            photos[existingIndex] = updatedPhoto;
                            console.log('Êõ¥Êñ∞Áé∞ÊúâÁÖßÁâá:', updatedPhoto);
                            
                            // Êõ¥Êñ∞Êú¨Âú∞Â≠òÂÇ®
                            localStorage.setItem('photos', JSON.stringify(photos));
                            console.log('Â∑≤Êõ¥Êñ∞Êú¨Âú∞Â≠òÂÇ®, ÊÄªÁÖßÁâáÊï∞:', photos.length);
                            
                            // ÈáçÊñ∞ÊéíÂ∫èÂíåÊòæÁ§∫
                            sortAndDisplayPhotos();
                            console.log('ÁÖßÁâáÊõ¥Êñ∞ÂÆåÊàê:', photoData.id);
                        }
                    }
                });
            }, error => {
                console.error('FirestoreÁõëÂê¨ÈîôËØØ:', error);
                console.error('ÈîôËØØ‰ª£Á†Å:', error.code);
                console.error('ÈîôËØØ‰ø°ÊÅØ:', error.message);
            });
            
            console.log('Firestore ÂÆûÊó∂ÁõëÂê¨Âô®ËÆæÁΩÆÂÆåÊàê');
}

// ÊµãËØïFirebaseÂÆâÂÖ®ËßÑÂàô
function testFirebaseRules() {
    console.log('ÂºÄÂßãÊµãËØïFirebaseÂÆâÂÖ®ËßÑÂàô...');
    console.log('‰ΩøÁî®ÂÖ±‰∫´ËÆøÈóÆÂØÜÈí•:', sharedAccessKey);
            
            // ÊµãËØïFirestoreËØªÂèñÊùÉÈôê
            photosCollection.limit(1).get()
                .then(snapshot => {
                    console.log('FirestoreËØªÂèñÊùÉÈôêÊµãËØïÊàêÂäü');
                })
                .catch(error => {
                    console.error('FirestoreËØªÂèñÊùÉÈôêÊµãËØïÂ§±Ë¥•:', error);
                    console.error('ÈîôËØØ‰ª£Á†Å:', error.code);
                    console.error('ÈîôËØØ‰ø°ÊÅØ:', error.message);
                    alert('ËØ∑Ê£ÄÊü•Firebase FirestoreÂÆâÂÖ®ËßÑÂàôÔºåÁ°Æ‰øùÂ∑≤ËÆæÁΩÆ‰∏∫ allow read, write: if true;');
                });
            
            // ÊµãËØïFirestoreÂÜôÂÖ•ÊùÉÈôê
            const testDocId = 'test-' + Date.now();
            photosCollection.doc(testDocId).set({test: true})
                .then(() => {
                    console.log('FirestoreÂÜôÂÖ•ÊùÉÈôêÊµãËØïÊàêÂäü');
                    // Ê∏ÖÁêÜÊµãËØïÊï∞ÊçÆ
                    photosCollection.doc(testDocId).delete()
                        .then(() => console.log('ÊµãËØïÊï∞ÊçÆÂ∑≤Ê∏ÖÁêÜ'))
                        .catch(e => console.error('Ê∏ÖÁêÜÊµãËØïÊï∞ÊçÆÂ§±Ë¥•:', e));
                })
                .catch(error => {
                    console.error('FirestoreÂÜôÂÖ•ÊùÉÈôêÊµãËØïÂ§±Ë¥•:', error);
                    console.error('ÈîôËØØ‰ª£Á†Å:', error.code);
                    console.error('ÈîôËØØ‰ø°ÊÅØ:', error.message);
                    alert('ËØ∑Ê£ÄÊü•Firebase FirestoreÂÆâÂÖ®ËßÑÂàôÔºåÁ°Æ‰øùÂ∑≤ËÆæÁΩÆ‰∏∫ allow read, write: if true;');
                });
            
            // ÊµãËØïStorageÂÜôÂÖ•ÊùÉÈôê
            const testBlob = new Blob(['test'], {type: 'text/plain'});
            const testRef = storage.ref('test/test-' + Date.now() + '.txt');
            testRef.put(testBlob)
                .then(() => {
                    console.log('StorageÂÜôÂÖ•ÊùÉÈôêÊµãËØïÊàêÂäü');
                    // Ê∏ÖÁêÜÊµãËØïÊï∞ÊçÆ
                    testRef.delete()
                        .then(() => console.log('StorageÊµãËØïÊï∞ÊçÆÂ∑≤Ê∏ÖÁêÜ'))
                        .catch(e => console.error('Ê∏ÖÁêÜStorageÊµãËØïÊï∞ÊçÆÂ§±Ë¥•:', e));
                })
                .catch(error => {
                    console.error('StorageÂÜôÂÖ•ÊùÉÈôêÊµãËØïÂ§±Ë¥•:', error);
                    console.error('ÈîôËØØ‰ª£Á†Å:', error.code);
                    console.error('ÈîôËØØ‰ø°ÊÅØ:', error.message);
                    alert('ËØ∑Ê£ÄÊü•Firebase StorageÂÆâÂÖ®ËßÑÂàôÔºåÁ°Æ‰øùÂ∑≤ËÆæÁΩÆ‰∏∫ allow read, write: if true;');
                });
        }
        
        // ÊéíÂ∫èÂπ∂ÊòæÁ§∫ÁÖßÁâá
        function sortAndDisplayPhotos() {
            // ÊéíÂ∫èÁÖßÁâá
            photos.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                
                if (currentSort === 'date-desc') {
                    return dateB - dateA;
                } else {
                    return dateA - dateB;
                }
            });
            
            // Ê∏ÖÁ©∫ÂÆπÂô®
            const container = document.getElementById('photos-container');
            container.innerHTML = '';
            
            // ÊòæÁ§∫ÁÖßÁâá
            photos.forEach(photo => {
                const photoCard = document.createElement('div');
                photoCard.className = 'photo-card';
                
                const img = document.createElement('img');
                img.src = photo.src;
                img.className = 'photo-img';
                img.alt = photo.name;
                img.onclick = function() {
                    openModal(photo.src);
                };
                
                const dateElement = document.createElement('div');
                dateElement.className = 'photo-date';
                dateElement.textContent = formatDate(photo.date);
                
                const memoryDiv = document.createElement('div');
                memoryDiv.className = 'photo-memory';
                
                const memoryText = document.createElement('p');
                memoryText.textContent = photo.memory || 'ÁÇπÂáªÊ∑ªÂä†ÂõûÂøÜ...';
                memoryText.style.cursor = 'pointer';
                memoryText.onclick = function() {
                    this.style.display = 'none';
                    memoryInput.style.display = 'block';
                    saveBtn.style.display = 'block';
                    memoryInput.focus();
                };
                
                const memoryInput = document.createElement('textarea');
                memoryInput.className = 'photo-memory-input';
                memoryInput.value = photo.memory || '';
                memoryInput.placeholder = 'ÂÜô‰∏ãËøôÂº†ÁÖßÁâáÁöÑÂõûÂøÜ...';
                memoryInput.style.display = 'none';
                
                const saveBtn = document.createElement('button');
                saveBtn.className = 'save-memory-btn';
                saveBtn.textContent = '‰øùÂ≠òÂõûÂøÜ';
                saveBtn.style.display = 'none';
                saveBtn.onclick = function() {
                    saveMemory(photo.id, memoryInput.value);
                    memoryText.textContent = memoryInput.value || 'ÁÇπÂáªÊ∑ªÂä†ÂõûÂøÜ...';
                    memoryInput.style.display = 'none';
                    saveBtn.style.display = 'none';
                    memoryText.style.display = 'block';
                };
                
                memoryDiv.appendChild(memoryText);
                memoryDiv.appendChild(memoryInput);
                memoryDiv.appendChild(saveBtn);
                
                // ÂàõÂª∫Âà†Èô§ÊåâÈíÆ
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '&#10005;'; // Ê∑ªÂä†‰∏Ä‰∏™XÁ¨¶Âè∑
                deleteBtn.title = 'Âà†Èô§ÁÖßÁâá';
                deleteBtn.onclick = function(e) {
                    e.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜ≤Á™Å
                    deletePhoto(photo.id);
                };
                
                photoCard.appendChild(img);
                photoCard.appendChild(dateElement);
                photoCard.appendChild(memoryDiv);
                photoCard.appendChild(deleteBtn);
                
                container.appendChild(photoCard);
            });
        }
        
        // Ê†ºÂºèÂåñÊó•Êúü
        function formatDate(date) {
            const options = { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            };
            return new Date(date).toLocaleDateString('zh-CN', options);
        }
        
        // ‰øùÂ≠òÂõûÂøÜ
        function saveMemory(photoId, memory) {
            console.log('ÂºÄÂßã‰øùÂ≠òÂõûÂøÜ, ÁÖßÁâáID:', photoId);
            // Êõ¥Êñ∞Êú¨Âú∞ÁÖßÁâáÊï∞ÊçÆ
            const photoIndex = photos.findIndex(p => p.id === photoId);
            if (photoIndex !== -1) {
                photos[photoIndex].memory = memory;
                console.log('Êõ¥Êñ∞‰∫ÜÊú¨Âú∞ÁÖßÁâáÂõûÂøÜ');
                
                // Êõ¥Êñ∞Êú¨Âú∞Â≠òÂÇ®
                localStorage.setItem('photos', JSON.stringify(photos));
                console.log('ÂõûÂøÜÂ∑≤‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®');
                
                // Â¶ÇÊûúÂ∑≤ÁôªÂΩïÔºåÊõ¥Êñ∞Firestore
                if (auth.currentUser) {
                    photosCollection.doc(photoId.toString()).update({
                        memory: memory
                    }).then(() => {
                        console.log('ÂõûÂøÜÂ∑≤‰øùÂ≠òÂà∞Firestore');
                    }).catch(error => {
                        console.error('‰øùÂ≠òÂõûÂøÜÂà∞FirestoreÂ§±Ë¥•:', error);
                        console.error('ÈîôËØØ‰ª£Á†Å:', error.code);
                        console.error('ÈîôËØØ‰ø°ÊÅØ:', error.message);
                    });
                }
            }
        }
        
        // ÊâìÂºÄÊ®°ÊÄÅÊ°Ü
        function openModal(src) {
            const modal = document.getElementById('modal');
            const modalImg = document.getElementById('modal-img');
            
            modal.style.display = 'flex';
            modalImg.src = src;
        }
        
        // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }
        
        // Êõ¥ÊîπÊéíÂ∫èÊñπÂºè
        function changeSort(sortType) {
            console.log('Êõ¥ÊîπÊéíÂ∫èÊñπÂºè‰∏∫:', sortType);
            currentSort = sortType;
            
            // Êõ¥Êñ∞ÊéíÂ∫èÊåâÈíÆÁä∂ÊÄÅ
            document.querySelectorAll('.sort-btn').forEach(btn => {
                if (btn.getAttribute('onclick').includes(sortType)) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // ÈáçÊñ∞ÊéíÂ∫èÂíåÊòæÁ§∫
            sortAndDisplayPhotos();
        }
        
        // Âà†Èô§ÁÖßÁâá
        function deletePhoto(photoId) {
            console.log('ÂºÄÂßãÂà†Èô§ÁÖßÁâá, ID:', photoId);
            
            // Á°ÆËÆ§Âà†Èô§
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÂº†ÁÖßÁâáÂêóÔºüÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ„ÄÇ')) {
                console.log('Áî®Êà∑ÂèñÊ∂àÂà†Èô§');
                return;
            }
            
            // ‰ªéÊú¨Âú∞Êï∞ÁªÑ‰∏≠Âà†Èô§
            const photoIndex = photos.findIndex(p => p.id === photoId);
            if (photoIndex === -1) {
                console.error('Êú™ÊâæÂà∞Ë¶ÅÂà†Èô§ÁöÑÁÖßÁâá:', photoId);
                return;
            }
            
            const photoToDelete = photos[photoIndex];
            console.log('ÊâæÂà∞Ë¶ÅÂà†Èô§ÁöÑÁÖßÁâá:', photoToDelete);
            
            // ‰ªéÊï∞ÁªÑ‰∏≠ÁßªÈô§
            photos.splice(photoIndex, 1);
            console.log('‰ªéÊú¨Âú∞Êï∞ÁªÑ‰∏≠Âà†Èô§ÁÖßÁâáÊàêÂäü');
            
            // Êõ¥Êñ∞Êú¨Âú∞Â≠òÂÇ®
            localStorage.setItem('photos', JSON.stringify(photos));
            console.log('Êõ¥Êñ∞Êú¨Âú∞Â≠òÂÇ®ÊàêÂäü');
            
            // ÈáçÊñ∞Ê∏≤ÊüìÁÖßÁâáÂàóË°®
            sortAndDisplayPhotos();
            
            // Â¶ÇÊûúÂ∑≤ÁôªÂΩïÔºå‰ªé Firestore Âíå Storage ‰∏≠Âà†Èô§
            if (auth.currentUser) {
                // ‰ªé Firestore ‰∏≠Âà†Èô§ÊñáÊ°£
                photosCollection.doc(photoId.toString()).delete()
                    .then(() => {
                        console.log('Firestore ÊñáÊ°£Âà†Èô§ÊàêÂäü:', photoId);
                        
                        // Â¶ÇÊûúÁÖßÁâáÈìæÊé•ÊòØÊù•Ëá™StorageÁöÑÔºåÂàôÂà†Èô§StorageÊñá‰ª∂
                        if (photoToDelete.src && photoToDelete.src.includes('firebasestorage.googleapis.com')) {
                            // ‰ªé URL ÊèêÂèñÊñá‰ª∂Ë∑ØÂæÑ
                            try {
                                const storageRef = storage.ref(`photos/${photoId}`);
                                storageRef.delete()
                                    .then(() => {
                                        console.log('Storage Êñá‰ª∂Âà†Èô§ÊàêÂäü:', photoId);
                                    })
                                    .catch(error => {
                                        console.error('Storage Êñá‰ª∂Âà†Èô§Â§±Ë¥•:', error);
                                        console.error('ÈîôËØØ‰ª£Á†Å:', error.code);
                                        console.error('ÈîôËØØ‰ø°ÊÅØ:', error.message);
                                    });
                            } catch (error) {
                                console.error('Â§ÑÁêÜStorageÊñá‰ª∂Âà†Èô§Êó∂Âá∫Èîô:', error);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Firestore ÊñáÊ°£Âà†Èô§Â§±Ë¥•:', error);
                        console.error('ÈîôËØØ‰ª£Á†Å:', error.code);
                        console.error('ÈîôËØØ‰ø°ÊÅØ:', error.message);
                    });
            }
        }
        
        // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜËÉåÊôØÂÖ≥Èó≠
        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        };
        
        
        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÊó∂ÁöÑ‰∫ã‰ª∂Â§ÑÁêÜ
        window.addEventListener('DOMContentLoaded', function() {
            console.log('È°µÈù¢Âä†ËΩΩÂÆåÊàê');
            
            // Á°Æ‰øù‰∏ä‰º†ÊåâÈíÆÁõëÂê¨Âô®Ë¢´ËÆæÁΩÆÔºåÊó†ËÆ∫ÁôªÂΩïÊòØÂê¶ÊàêÂäü
            setTimeout(function() {
                // Â¶ÇÊûú5ÁßíÂêé‰ªçÊú™ËÆæÁΩÆ‰∏ä‰º†ÁõëÂê¨Âô®ÔºåÂàôÂº∫Âà∂ËÆæÁΩÆ
                setupUploadListener();
                console.log('Á°Æ‰øù‰∏ä‰º†ÊåâÈíÆÁõëÂê¨Âô®Â∑≤ËÆæÁΩÆ');
                
                // Â¶ÇÊûúÂõæÁâáËøòÊú™Âä†ËΩΩÔºåÂ∞ùËØïÂÜçÊ¨°Âä†ËΩΩ
                if (photos.length === 0) {
                    loadPhotosFromLocalStorage();
                }
            }, 5000);
        });
    </script>
</body>
</html>
