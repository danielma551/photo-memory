<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘ä»¬çš„å›å¿† | æµªæ¼«ç›¸å†Œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            text-align: center;
        }

        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 2.5rem;
            font-weight: 600;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.2rem;
        }

        .upload-container {
            background-color: #f9f9f9;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .upload-btn {
            background-color: #ff6b6b;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
            margin: 10px;
        }

        .upload-btn:hover {
            background-color: #ff5252;
        }

        .sort-container {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .sort-btn {
            background-color: #f0f0f0;
            color: #333;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .sort-btn:hover, .sort-btn.active {
            background-color: #ff6b6b;
            color: white;
        }

        .photos-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 30px;
        }

        .photo-card {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .photo-img {
            width: 100%;
            height: auto;
            display: block;
            cursor: pointer;
        }

        .photo-date {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
        }

        .photo-memory {
            padding: 15px;
            text-align: left;
            color: #333;
        }
        
        .delete-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(255, 0, 0, 0.7);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.2s ease;
        }
        
        .delete-btn:hover {
            background-color: rgba(255, 0, 0, 0.9);
            transform: scale(1.1);
        }

        .photo-memory-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-top: 10px;
            font-family: inherit;
        }

        .save-memory-btn {
            background-color: #4CAF50;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
            font-size: 0.9rem;
        }

        .save-memory-btn:hover {
            background-color: #45a049;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow: auto;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            max-width: 80%;
            max-height: 80%;
        }

        .modal-img {
            width: 100%;
            height: auto;
            border-radius: 5px;
        }

        .close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
        }

        .heart-icon {
            color: #ff6b6b;
            font-size: 1.5rem;
            margin: 0 5px;
        }

        @media (max-width: 768px) {
            .photos-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
</head>
<body>
    <div class="container">
        <h1><span class="heart-icon">â¤ï¸</span>æˆ‘ä»¬çš„å›å¿†<span class="heart-icon">â¤ï¸</span></h1>
        <p class="subtitle">è®°å½•æ¯ä¸€ä¸ªç¾å¥½ç¬é—´</p>
        
        <div class="upload-container">
            <label for="photo-upload" class="upload-btn">
                ğŸ“· ç‚¹å‡»ä¸Šä¼ ç…§ç‰‡
            </label>
            <input type="file" id="photo-upload" accept="image/*" style="display: none;" multiple>
            <p>æ”¯æŒç‚¹å‡»ï¼Œå°†è‡ªåŠ¨è°ƒæ•´å¹¶æ·»åŠ åˆ°ç›¸å†Œ</p>
        </div>
        
        <div class="sort-container">
            <button class="sort-btn" onclick="changeSort('date-desc')">æœ€æ–°ä¼˜å…ˆ</button>
            <button class="sort-btn" onclick="changeSort('date-asc')">æœ€æ—©ä¼˜å…ˆ</button>
        </div>
        
        <div id="photos-container" class="photos-container">
            <!-- ç…§ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
        </div>
    </div>
    
    <div id="modal" class="modal">
        <span class="close" onclick="closeModal()">&times;</span>
        <img class="modal-content" id="modal-img">
    </div>
    
    <script>
        // Firebaseé…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyDFdBeoY2IKG_O23tiAtpK2gLuTfyaGaYk",
            authDomain: "photo-memory-596ef.firebaseapp.com",
            projectId: "photo-memory-596ef",
            storageBucket: "photo-memory-596ef.firebasestorage.app",
            messagingSenderId: "963316273567",
            appId: "1:963316273567:web:10ac3d837aa19afee12daa",
            measurementId: "G-BTHDGQERVF",
            databaseURL: "https://photo-memory-596ef-default-rtdb.firebaseio.com" // æ·»åŠ Realtime Database URL
        };
        
        // åˆå§‹åŒ–Firebase
        firebase.initializeApp(firebaseConfig);
        
        // è·å–FirebaseæœåŠ¡å¼•ç”¨
        const storage = firebase.storage();
        const auth = firebase.auth();
        const firestore = firebase.firestore();
        
        // æ·»åŠ è¯Šæ–­æ—¥å¿—
        console.log('Firebaseåˆå§‹åŒ–å®Œæˆ');
        console.log('Firestoreå¼•ç”¨:', firestore);
        console.log('Storageå¼•ç”¨:', storage);
        
        // ä½¿ç”¨Firestoreå­˜å‚¨ç…§ç‰‡æ•°æ®
        // ä½¿ç”¨å…±äº«ç›¸å†ŒIDä½œä¸ºé›†åˆåç§°ä¸€éƒ¨åˆ†ï¼Œä»¥ç¡®ä¿æ‰€æœ‰è®¾å¤‡è®¿é—®ç›¸åŒçš„é›†åˆ
        const albumId = 'shared-album';
        // ä½¿ç”¨å›ºå®šç›¸å†ŒIDä½œä¸ºé›†åˆè·¯å¾„ï¼Œç¡®ä¿æ‰€æœ‰è®¾å¤‡è®¿é—®ç›¸åŒçš„æ•°æ®
        const photosCollection = firestore.collection('albums').doc(albumId).collection('photos');
        console.log('ä½¿ç”¨å…±äº«ç›¸å†Œé›†åˆè·¯å¾„: albums/' + albumId + '/photos');
        
        // ç…§ç‰‡æ•°æ®å’Œæ’åºè®¾ç½®
        let photos = [];
        let currentSort = 'date-desc';
        let syncInterval;
        
        // åˆ›å»ºæˆ–è·å–å…±äº«è®¿é—®å¯†é’¥ï¼Œç”¨äºè·¨è®¾å¤‡è®¿é—®
        let sharedAccessKey = localStorage.getItem('sharedAccessKey');
        if (!sharedAccessKey) {
            // å¦‚æœæ²¡æœ‰å­˜å‚¨çš„è®¿é—®å¯†é’¥ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„
            sharedAccessKey = 'shared-album-' + Date.now();
            localStorage.setItem('sharedAccessKey', sharedAccessKey);
            console.log('åˆ›å»ºäº†æ–°çš„å…±äº«è®¿é—®å¯†é’¥:', sharedAccessKey);
        } else {
            console.log('ä½¿ç”¨ç°æœ‰å…±äº«è®¿é—®å¯†é’¥:', sharedAccessKey);
        }
        
        // åŒ¿åç™»å½•
        console.log('å¼€å§‹åŒ¿åç™»å½•...');
        auth.signInAnonymously()
            .then((userCredential) => {
                console.log('åŒ¿åç™»å½•æˆåŠŸ');
                console.log('ç”¨æˆ·ID:', userCredential.user.uid);
                
                // å°†å…±äº«è®¿é—®å¯†é’¥æ·»åŠ åˆ°ç”¨æˆ·çš„è‡ªå®šä¹‰å£°æ˜ä¸­
                const user = userCredential.user;
                user.getIdToken(true).then(function(token) {
                    console.log('è·å–åˆ°ç”¨æˆ·ä»¤ç‰Œï¼Œè®¾ç½®å…±äº«è®¿é—®');
                });
                console.log('ç”¨æˆ·å¯¹è±¡:', userCredential.user);
                // ç™»å½•æˆåŠŸååŠ è½½ç…§ç‰‡
                loadPhotosFromFirebase();
                
                // è®¾ç½®ä¸Šä¼ æŒ‰é’®ç›‘å¬å™¨
                setupUploadListener();
            })
            .catch(error => {
                console.error(' åŒ¿åç™»å½•å¤±è´¥:', error);
                console.error('é”™è¯¯ä»£ç :', error.code);
                console.error('é”™è¯¯ä¿¡æ¯:', error.message);
                // å³ä½¿ç™»å½•å¤±è´¥ä¹Ÿä»æœ¬åœ°åŠ è½½ç…§ç‰‡
                loadPhotosFromLocalStorage();
                
                // ç™»å½•å¤±è´¥ä¹Ÿè¦è®¾ç½®ä¸Šä¼ æŒ‰é’®ç›‘å¬å™¨
                setupUploadListener();
            });
        
        // Flag to prevent multiple simultaneous upload processing
        let isProcessingUpload = false;

        // æ·»åŠ æ–‡ä»¶ä¸Šä¼ äº‹ä»¶ç›‘å¬å™¨
        function setupUploadListener() {
            console.log('è®¾ç½®ä¸Šä¼ æŒ‰é’®ç›‘å¬å™¨...');
            const uploadInput = document.getElementById('photo-upload');
            if (uploadInput) {
                console.log('æ‰¾åˆ°ä¸Šä¼ æŒ‰é’®å…ƒç´ :', uploadInput);
                uploadInput.addEventListener('change', async function(event) { // Made event handler async
                    if (isProcessingUpload) {
                        console.warn('ä¸Šä¼ å¤„ç†ä¸­ï¼Œå¿½ç•¥æ­¤æ¬¡æ–‡ä»¶é€‰æ‹©äº‹ä»¶ã€‚');
                        event.target.value = null; // Clear input to allow re-selection if needed
                        return;
                    }
                    isProcessingUpload = true;

                    console.log('æ£€æµ‹åˆ°æ–‡ä»¶é€‰æ‹©äº‹ä»¶');
                    const files = event.target.files;
                    console.log('é€‰æ‹©çš„æ–‡ä»¶æ•°é‡:', files ? files.length : 0);
                    if (files && files.length > 0) {
                        for (let i = 0; i < files.length; i++) {
                            console.log('å¼€å§‹å¤„ç†ç¬¬', i+1, 'ä¸ªæ–‡ä»¶:', files[i].name);
                            try {
                                // Assuming processAndUploadPhoto might involve async operations or return a Promise
                                await processAndUploadPhoto(files[i]);
                            } catch (error) {
                                console.error('å¤„ç†æˆ–ä¸Šä¼ æ–‡ä»¶æ—¶å‡ºé”™:', files[i].name, error);
                                // Consider adding user feedback here if a specific file fails
                            }
                        }
                    }
                    
                    // Reset the flag after all files in the current selection have been processed (or attempted)
                    isProcessingUpload = false;
                    // Clear the file input to allow re-selection of the same file(s) if the user wants to.
                    // This is important because without it, selecting the same file again might not trigger the 'change' event.
                    event.target.value = null;
                });
                console.log('ä¸Šä¼ æŒ‰é’®ç›‘å¬å™¨è®¾ç½®æˆåŠŸ');
            } else {
                console.error('æ‰¾ä¸åˆ°ä¸Šä¼ æŒ‰é’®å…ƒç´ !');
            }
        }
        
        // å¤„ç†å’Œä¸Šä¼ ç…§ç‰‡
        function processAndUploadPhoto(file) {
            console.log('å¼€å§‹å¤„ç†ç…§ç‰‡:', file.name, 'å¤§å°:', (file.size / 1024 / 1024).toFixed(2), 'MB', 'ç±»å‹:', file.type);
            
            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.type.startsWith('image/')) {
                // æ£€æŸ¥æ–‡ä»¶åæ‰«å°¾ï¼Œå…è®¸ä¸€äº›å¸¸è§çš„å›¾ç‰‡æ ¼å¼
                const fileName = file.name.toLowerCase();
                const validExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.heic', '.heif'];
                const isValidExtension = validExtensions.some(ext => fileName.endsWith(ext));
                
                if (!isValidExtension) {
                    console.error('æ— æ•ˆçš„æ–‡ä»¶ç±»å‹:', file.type, 'æ–‡ä»¶å:', fileName);
                    alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶ (JPG, PNG, GIFç­‰)');
                    return;
                }
                
                console.warn('æ–‡ä»¶MIMEç±»å‹ä¸æ˜¯image/ï¼Œä½†æ–‡ä»¶æ‰©å±•åæœ‰æ•ˆï¼Œå°è¯•å¤„ç†:', fileName);
            }
            
            // æœ€å¤§å…è®¸å¤§å°ï¼Œ10MB
            const maxFileSize = 10 * 1024 * 1024;
            if (file.size > maxFileSize) {
                console.warn('æ–‡ä»¶è¶…è¿‡å¤§å°é™åˆ¶:', (file.size / 1024 / 1024).toFixed(2), 'MB');
            }
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                console.log('æ–‡ä»¶è¯»å–å®Œæˆ');
                const img = new Image();
                
                img.onload = function() {
                    console.log('å›¾ç‰‡å°ºå¯¸:', img.width, 'x', img.height);
                    
                    // å‹ç¼©å¤§å›¾ç‰‡
                    let imageDataUrl = e.target.result;
                    if (file.size > maxFileSize) {
                        console.log('å¼€å§‹å‹ç¼©å›¾ç‰‡...');
                        imageDataUrl = compressImage(img, file.type);
                        console.log('å›¾ç‰‡å‹ç¼©å®Œæˆ');
                    }
                    
                    // åˆ›å»ºç…§ç‰‡æ•°æ®å¯¹è±¡
                    const photoData = {
                        id: Date.now() + Math.floor(Math.random() * 1000),
                        name: file.name,
                        src: imageDataUrl,
                        date: new Date().toISOString(),
                        memory: ''
                    };
                    
                    // ä¸Šä¼ åˆ°Firebase
                    uploadPhotoToFirebase(photoData);
                };
                
                img.onerror = function() {
                    console.error('åŠ è½½å›¾ç‰‡å‡ºé”™');
                    alert('æ— æ³•åŠ è½½æ‰€é€‰å›¾ç‰‡ï¼Œè¯·ç¡®ä¿æ–‡ä»¶å®Œå¥½');
                };
                
                img.src = e.target.result;
            };
            
            reader.onerror = function() {
                console.error('è¯»å–æ–‡ä»¶å‡ºé”™');
                alert('è¯»å–æ–‡ä»¶å¤±è´¥ï¼Œè¯·é‡è¯•');
            };
            
            reader.readAsDataURL(file);
        }
        
        // å‹ç¼©å›¾ç‰‡
        function compressImage(img, mimeType) {
            console.log('å‹ç¼©å‰å›¾ç‰‡å°ºå¯¸:', img.width, 'x', img.height, 'ç±»å‹:', mimeType);
            
            // å¤„ç†ç‰¹æ®Šæ ¼å¼
            // GIFå’ŒPNGç­‰ä¿ç•™åŸå§‹æ ¼å¼ç‰¹æ€§ï¼ˆå¦‚åŠ¨ç”»å’Œé€æ˜åº¦ï¼‰
            if (mimeType === 'image/gif') {
                console.log('æ£€æµ‹åˆ°GIFæ ¼å¼ï¼Œè·³è¿‡å‹ç¼©ä»¥ä¿ç•™åŠ¨ç”»æ•ˆæœ');
                return img.src; // ä¿ç•™åŸå§‹æ ¼å¼
            }
            
            // å¯¹äºPNGå›¾ç‰‡ï¼Œå¦‚æœéœ€è¦ä¿ç•™é€æ˜åº¦ï¼Œä½¿ç”¨æ›´é«˜çš„è´¨é‡
            let quality = 0.7; // é»˜è®¤è´¨é‡
            let targetMimeType = mimeType;
            
            if (mimeType === 'image/png' || mimeType === 'image/webp') {
                // æ£€æŸ¥æ˜¯å¦æœ‰é€æ˜åº¦
                const hasTransparency = checkImageTransparency(img);
                if (hasTransparency) {
                    console.log('æ£€æµ‹åˆ°é€æ˜å›¾ç‰‡ï¼Œä½¿ç”¨æ›´é«˜è´¨é‡å’Œå…¼å®¹æ ¼å¼');
                    quality = 0.9; // æé«˜è´¨é‡ä¿ç•™é€æ˜æ•ˆæœ
                } else {
                    // å¦‚æœæ²¡æœ‰é€æ˜åº¦ï¼Œå¯ä»¥è½¬ä¸ºJPEGä»¥è·å¾—æ›´å¥½çš„å‹ç¼©æ•ˆæœ
                    console.log('PNG/WebPå›¾ç‰‡æ— é€æ˜åº¦ï¼Œè€ƒè™‘è½¬æ¢ä¸ºJPEGä»¥æé«˜å‹ç¼©æ•ˆç‡');
                    targetMimeType = 'image/jpeg';
                }
            }
            
            // è®¡ç®—å‹ç¼©åçš„å°ºå¯¸ï¼Œä¿æŒçºµæ¨ªæ¯”
            const maxWidth = 1600;
            const maxHeight = 1600;
            let width = img.width;
            let height = img.height;
            
            // ä»…å½“åŸå§‹å°ºå¯¸è¶…è¿‡é™åˆ¶æ—¶æ‰ç¼©å°
            if (width > maxWidth || height > maxHeight) {
                if (width > height) {
                    if (width > maxWidth) {
                        height = Math.round((height * maxWidth) / width);
                        width = maxWidth;
                    }
                } else {
                    if (height > maxHeight) {
                        width = Math.round((width * maxHeight) / height);
                        height = maxHeight;
                    }
                }
                console.log('å‹ç¼©åå›¾ç‰‡å°ºå¯¸:', width, 'x', height);
            } else {
                console.log('å›¾ç‰‡å°ºå¯¸åœ¨åˆç†èŒƒå›´å†…ï¼Œä¿æŒåŸå§‹å°ºå¯¸');
            }
            
            try {
                // åˆ›å»ºCanvasè¿›è¡Œå‹ç¼©
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                
                // å¯¹JPEGè¿›è¡Œç™½è‰²èƒŒæ™¯å¡«å……
                if (targetMimeType === 'image/jpeg') {
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, width, height);
                }
                
                // ç»˜åˆ¶å›¾ç‰‡
                ctx.drawImage(img, 0, 0, width, height);
                
                // è½¬æ¢ä¸ºDataURLï¼Œé€‰æ‹©å‹ç¼©è´¨é‡
                const compressedDataUrl = canvas.toDataURL(targetMimeType, quality);
                
                // æ£€æŸ¥å‹ç¼©ç»“æœ
                const originalSize = Math.round(img.src.length / 1024 / 1024 * 0.75);
                const compressedSize = Math.round(compressedDataUrl.length / 1024 / 1024 * 0.75);
                console.log('åŸå§‹å›¾ç‰‡å¤§å°çº¦:', originalSize, 'MB');
                console.log('å‹ç¼©åå›¾ç‰‡å¤§å°çº¦:', compressedSize, 'MB');
                
                // å¦‚æœå‹ç¼©ååè€Œå˜å¤§ï¼Œè¿”å›åŸå§‹å›¾ç‰‡
                if (compressedSize > originalSize * 1.1) { // å¦‚æœå¤§äºåŸå§‹å¤§1.1å€
                    console.warn('å‹ç¼©åå›¾ç‰‡å¤§å°å¢åŠ ï¼Œä½¿ç”¨åŸå§‹å›¾ç‰‡');
                    return img.src;
                }
                
                return compressedDataUrl;
            } catch (error) {
                console.error('å‹ç¼©å›¾ç‰‡æ—¶å‡ºé”™:', error);
                // å‡ºé”™æ—¶è¿”å›åŸå§‹å›¾ç‰‡
                return img.src;
            }
        }

        // æ£€æŸ¥å›¾ç‰‡æ˜¯å¦æœ‰é€æ˜åº¦
        function checkImageTransparency(img) {
            try {
                // åˆ›å»ºä¸´æ—¶canvas
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // ä½¿ç”¨å°å°ºå¯¸æé«˜æ€§èƒ½
                const size = Math.min(50, img.width, img.height);
                canvas.width = size;
                canvas.height = size;
                
                // ç»˜åˆ¶å›¾ç‰‡
                ctx.drawImage(img, 0, 0, size, size);
                
                // è·å–åƒç´ æ•°æ®
                const imageData = ctx.getImageData(0, 0, size, size).data;
                
                // æ£€æŸ¥æ˜¯å¦å­˜åœ¨éå®Œå…¨ä¸é€æ˜çš„åƒç´ 
                for (let i = 3; i < imageData.length; i += 4) {
                    if (imageData[i] < 255) { // alphaå€¼å°äº255è¡¨ç¤ºæœ‰é€æ˜åº¦
                        return true;
                    }
                }
                
                return false;
            } catch (error) {
                console.error('æ£€æŸ¥å›¾ç‰‡é€æ˜åº¦æ—¶å‡ºé”™:', error);
                // å¦‚æœå‡ºé”™ï¼Œå®‰å…¨èµ·è§å‡è®¾æœ‰é€æ˜åº¦
                return true;
            }
        }
        
        // å°†ç…§ç‰‡ä¸Šä¼ åˆ°Firebase
        function uploadPhotoToFirebase(photoData, retryCount = 0) {
            console.log('å¼€å§‹ä¸Šä¼ ç…§ç‰‡åˆ°Firebase, ç…§ç‰‡ID:', photoData.id, retryCount > 0 ? `(é‡è¯•ç¬¬${retryCount}æ¬¡)` : '');
            
            // æœ€å¤§é‡è¯•æ¬¡æ•°
            const MAX_RETRIES = 3;
            // å½“å‰å·²ç»è¶…è¿‡é‡è¯•æ¬¡æ•°
            if (retryCount > MAX_RETRIES) {
                console.error(`ä¸Šä¼ å¤±è´¥ï¼Œå·²è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°(${MAX_RETRIES}æ¬¡)`);
                alert('ç…§ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œå·²è‡ªåŠ¨ä¿å­˜åˆ°æœ¬åœ°ï¼Œç¨åå°†è‡ªåŠ¨é‡è¯•åŒæ­¥ã€‚');
                return;
            }
            
            try {
                // å…ˆä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼Œç¡®ä¿ç…§ç‰‡ç«‹å³æ˜¾ç¤º
                savePhotoToLocalStorage(photoData);
                console.log('ç…§ç‰‡å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
                
                // å¦‚æœæœªç™»å½•ï¼Œåªä¿å­˜åˆ°æœ¬åœ°
                if (!auth.currentUser) {
                    console.log('æœªç™»å½•ï¼Œç…§ç‰‡åªä¿å­˜åœ¨æœ¬åœ°');
                    return;
                }
                console.log('å·²ç™»å½•ï¼Œç”¨æˆ·ID:', auth.currentUser.uid);

                // åˆ›å»ºTimeoutä»¥é˜²æ­¢è¶…æ—¶
                let uploadTimeout;
                const UPLOAD_TIMEOUT = 60000; // 60ç§’è¶…æ—¶
                
                // å°†base64è½¬æ¢ä¸ºBlob
                let imageBlob;
                try {
                    imageBlob = dataURItoBlob(photoData.src);
                    console.log('å·²å°†å›¾ç‰‡è½¬æ¢ä¸ºBlob, å¤§å°:', imageBlob.size, 'bytes');
                } catch (error) {
                    console.error('å›¾ç‰‡è½¬æ¢å¤±è´¥:', error);
                    // å›¾ç‰‡æ ¼å¼é—®é¢˜ï¼Œä¸é‡è¯•
                    alert('å›¾ç‰‡æ ¼å¼æ— æ•ˆï¼Œè¯·é€‰æ‹©å…¶ä»–å›¾ç‰‡ã€‚');
                    return;
                }
                
                // åˆ›å»ºStorageå¼•ç”¨
                const storageRef = storage.ref(`photos/${photoData.id}`);
                console.log('åˆ›å»º Storage å¼•ç”¨:', `photos/${photoData.id}`);
                
                // è®¾ç½®è‡ªå®šä¹‰å…ƒæ•°æ®ä»¥æé«˜æˆåŠŸç‡
                const metadata = {
                    contentType: imageBlob.type,
                    customMetadata: {
                        'originalName': photoData.name,
                        'uploadTime': new Date().toISOString(),
                        'fileSize': imageBlob.size.toString(),
                        'deviceInfo': navigator.userAgent
                    }
                };
                
                // æ¸…é™¤ä¹‹å‰çš„è¶…æ—¶
                clearTimeout(uploadTimeout);
                
                // è®¾ç½®æ–°çš„è¶…æ—¶
                uploadTimeout = setTimeout(() => {
                    console.warn(`ä¸Šä¼ è¶…æ—¶(${UPLOAD_TIMEOUT / 1000}s)ï¼Œå°†è‡ªåŠ¨é‡è¯•`);
                    // é‡è¯•ä¸Šä¼ 
                    uploadPhotoToFirebase(photoData, retryCount + 1);
                }, UPLOAD_TIMEOUT);
                
                // åˆ¤æ–­æ˜¯å¦éœ€è¦ä½¿ç”¨åˆ†å—ä¸Šä¼ 
                const CHUNK_THRESHOLD = 2 * 1024 * 1024; // 2MBä»¥ä¸Šä½¿ç”¨åˆ†å—ä¸Šä¼ 
                let uploadTask;
                
                if (imageBlob.size > CHUNK_THRESHOLD) {
                    console.log('å›¾ç‰‡å¤§å°è¶…è¿‡', (CHUNK_THRESHOLD / 1024 / 1024), 'MB, å°è¯•ä½¿ç”¨æ›´å¯é çš„ä¸Šä¼ æ–¹å¼');
                    
                    try {
                        // å¯¹äºå¤§æ–‡ä»¶ï¼Œæˆ‘ä»¬å°è¯•å…ˆå¼€å§‹ä¸Šä¼ ï¼Œç„¶åè¿›è¡Œæš‚åœå’Œæ¢å¤æ¨¡æ‹Ÿ
                        uploadTask = storageRef.put(imageBlob, metadata);
                        console.log('å¼€å§‹ä¸Šä¼ å¤§å‹ç…§ç‰‡åˆ° Storage...', 'å¤§å°:', (imageBlob.size / 1024 / 1024).toFixed(2), 'MB');
                    } catch (error) {
                        console.error('åˆ›å»ºStorageä¸Šä¼ ä»»åŠ¡å¤±è´¥:', error);
                        // å¦‚æœåˆ›å»ºuploadTaskå¤±è´¥ï¼Œå°è¯•æ›´ç®€å•çš„æ–¹å¼
                        try {
                            console.log('å°è¯•ä½¿ç”¨å¤‡ç”¨ä¸Šä¼ æ–¹å¼');
                            uploadTask = storageRef.put(imageBlob);
                        } catch (e) {
                            console.error('å¤‡ç”¨ä¸Šä¼ æ–¹å¼ä¹Ÿå¤±è´¥:', e);
                            throw e; // é‡æ–°æŠ›å‡ºä»¥è¿›å…¥é”™è¯¯å¤„ç†
                        }
                    }
                } else {
                    // å¯¹äºå°æ–‡ä»¶ï¼Œç›´æ¥ä½¿ç”¨æ ‡å‡†ä¸Šä¼ 
                    uploadTask = storageRef.put(imageBlob, metadata);
                    console.log('å¼€å§‹ä¸Šä¼ ç…§ç‰‡åˆ° Storage...', 'å¤§å°:', (imageBlob.size / 1024 / 1024).toFixed(2), 'MB');
                }
                
                // ä¸Šä¼ æ–­ç‚¹ç»­ä¼ 
                uploadTask.on('state_changed', 
                    // è¿›åº¦å›è°ƒ
                    (snapshot) => {
                        try {
                            // æ¯æ¬¡è¿›åº¦æ›´æ–°æ—¶é‡ç½®è¶…æ—¶è®¡æ—¶å™¨
                            clearTimeout(uploadTimeout);
                            
                            // æ›´æ–°ä¸Šä¼ è¿›åº¦
                            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                            console.log('ä¸Šä¼ è¿›åº¦: ' + progress.toFixed(2) + '%');
                            
                            // æ¯é—´10%è¿›åº¦è®°å½•è¯¦ç»†ä¿¡æ¯
                            if (Math.floor(progress) % 10 === 0) {
                                console.log(`ä¸Šä¼ è¿›åº¦é‡: ${snapshot.bytesTransferred} / ${snapshot.totalBytes} å­—èŠ‚`);
                            }
                            
                            // è®¾ç½®è¶…æ—¶è®¡æ—¶å™¨
                            uploadTimeout = setTimeout(() => {
                                console.warn(`ä¸Šä¼ è¶…æ—¶(${UPLOAD_TIMEOUT / 1000}s)ï¼Œå°†è‡ªåŠ¨é‡è¯•`);
                                try {
                                    // åœ¨è¶…æ—¶å‰å°è¯•å–æ¶ˆä¸Šä¼ 
                                    uploadTask.cancel().then(() => {
                                        console.log('è¶…æ—¶ä¸Šä¼ æˆåŠŸå–æ¶ˆ');
                                        // é‡è¯•ä¸Šä¼ 
                                        uploadPhotoToFirebase(photoData, retryCount + 1);
                                    }).catch(err => {
                                        console.error('å–æ¶ˆè¶…æ—¶ä¸Šä¼ å¤±è´¥:', err);
                                        // ä»ç„¶é‡è¯•ä¸Šä¼ 
                                        uploadPhotoToFirebase(photoData, retryCount + 1);
                                    });
                                } catch (cancelError) {
                                    console.error('å–æ¶ˆä¸Šä¼ æ—¶å‡ºé”™:', cancelError);
                                    // ç›´æ¥é‡è¯•ä¸Šä¼ 
                                    uploadPhotoToFirebase(photoData, retryCount + 1);
                                }
                            }, UPLOAD_TIMEOUT);
                            
                            // å¦‚æœè¿›åº¦å¤§äº90%ï¼Œå»¶é•¿è¶…æ—¶æ—¶é—´
                            if (progress > 90 && uploadTimeout) {
                                clearTimeout(uploadTimeout);
                                // å»¶é•¿è¶…æ—¶æ—¶é—´ç»™å³å°†å®Œæˆçš„ä¸Šä¼ 
                                uploadTimeout = setTimeout(() => {
                                    console.warn('å°½ç®¡ä¸Šä¼ è¿›åº¦è¶…è¿‡90%ï¼Œä½†ä»ç„¶è¶…æ—¶ï¼Œå°è¯•å–æ¶ˆå¹¶é‡è¯•');
                                    try {
                                        uploadTask.cancel();
                                    } catch (e) {
                                        console.error('å–æ¶ˆä¸Šä¼ å¤±è´¥:', e);
                                    }
                                    uploadPhotoToFirebase(photoData, retryCount + 1);
                                }, 30000); // 30ç§’è¶…æ—¶
                            }
                            
                            // è®°å½•å½“å‰çŠ¶æ€
                            switch (snapshot.state) {
                                case 'paused':
                                    console.log('ä¸Šä¼ å·²æš‚åœ');
                                    break;
                                case 'running':
                                    console.log('ä¸Šä¼ æ­£åœ¨è¿›è¡Œ');
                                    break;
                            }
                        } catch (progressError) {
                            console.error('å¤„ç†ä¸Šä¼ è¿›åº¦æ—¶å‡ºé”™:', progressError);
                        }
                    },
                    // é”™è¯¯å›è°ƒ
                    (error) => {
                        // æ¸…é™¤è¶…æ—¶è®¡æ—¶å™¨
                        clearTimeout(uploadTimeout);
                        console.error('ä¸Šä¼ å¤±è´¥:', error.code, error.message);
                        
                        // æ ¹æ®é”™è¯¯ç±»å‹å†³å®šæ˜¯å¦éœ€è¦é‡è¯•
                        if (retryCount < MAX_RETRIES) {
                            // æ‰©å±•å¯é‡è¯•çš„é”™è¯¯ç±»å‹
                            const retryableErrors = [
                                'storage/server-error', 
                                'storage/retry-limit-exceeded',
                                'storage/network-error',
                                'storage/unknown',
                                'storage/quota-exceeded',
                                'storage/timeout',
                                'storage/canceled',
                                'storage/invalid-url'
                            ];
                            
                            if (retryableErrors.includes(error.code) || !error.code) {
                                // æ ¹æ®é‡è¯•æ¬¡æ•°å¢åŠ å»¶è¿Ÿ
                                const retryDelayWithBackoff = RETRY_DELAY * Math.pow(2, retryCount);
                                console.log(`å°†åœ¨${retryDelayWithBackoff/1000}ç§’åè¿›è¡Œç¬¬${retryCount + 1}æ¬¡é‡è¯•...`);
                                
                                setTimeout(() => {
                                    try {
                                        // é‡è¯•å‰å°è¯•æ£€æŸ¥ç½‘ç»œçŠ¶æ€
                                        if (!navigator.onLine) {
                                            console.warn('è®¾å¤‡ç¦»çº¿ï¼Œç­‰å¾…ç½‘ç»œæ¢å¤åé‡è¯•');
                                            // ç›‘å¬ç½‘ç»œæ¢å¤äº‹ä»¶
                                            window.addEventListener('online', function onlineHandler() {
                                                window.removeEventListener('online', onlineHandler);
                                                console.log('ç½‘ç»œå·²æ¢å¤ï¼Œå°è¯•é‡æ–°ä¸Šä¼ ');
                                                uploadPhotoToFirebase(photoData, retryCount + 1);
                                            });
                                        } else {
                                            uploadPhotoToFirebase(photoData, retryCount + 1);
                                        }
                                    } catch (e) {
                                        console.error('é‡è¯•å‡†å¤‡è¿‡ç¨‹ä¸­å‡ºé”™:', e);
                                        uploadPhotoToFirebase(photoData, retryCount + 1);
                                    }
                                }, retryDelayWithBackoff);
                            } else {
                                // å…¶ä»–é”™è¯¯ä¸éœ€è¦é‡è¯•ï¼Œå¦‚æƒé™ä¸è¶³æˆ–å–æ¶ˆç­‰
                                console.error('ä¸å¯é‡è¯•çš„é”™è¯¯ç±»å‹:', error.code);
                                alert(`ä¸Šä¼ å¤±è´¥: ${error.message}\né”™è¯¯ç±»å‹: ${error.code}`);
                            }
                        } else {
                            alert(`å·²å°è¯•${MAX_RETRIES}æ¬¡ä¸Šä¼ ï¼Œä½†ä»ç„¶å¤±è´¥ã€‚è¯·ç¨åå†è¯•ã€‚`);
                        }
                    },
                    // æˆåŠŸå›è°ƒ
                    () => {
                        // æ¸…é™¤è¶…æ—¶è®¡æ—¶å™¨
                        clearTimeout(uploadTimeout);
                        
                        // ä¸Šä¼ å®Œæˆï¼Œè·å–ä¸‹è½½é“¾æ¥
                        console.log('ç…§ç‰‡ä¸Šä¼ å®Œæˆï¼Œæ­£åœ¨è·å–ä¸‹è½½ URL...');
                        uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                            console.log('å›¾ç‰‡å¯åœ¨ä»¥ä¸‹åœ°å€è®¿é—®:', downloadURL);
                            
                            // ä¿å­˜ç…§ç‰‡æ•°æ®åˆ°Firestore
                            console.log('å‡†å¤‡ä¿å­˜ç…§ç‰‡æ•°æ®åˆ° Firestore...');
                            const photoToSave = {
                                id: photoData.id,
                                name: photoData.name,
                                src: downloadURL,
                                date: firebase.firestore.Timestamp.fromDate(new Date(photoData.date)),
                                memory: photoData.memory || ''
                            };
                            console.log('è¦ä¿å­˜çš„ç…§ç‰‡æ•°æ®:', photoToSave);
                            
                            // è®¾ç½®Firestoreå†™å…¥è¶…æ—¶
                            const firestoreTimeout = setTimeout(() => {
                                console.warn('ä¿å­˜åˆ°Firestoreè¶…æ—¶ï¼Œå°†æ›´æ–°æœ¬åœ°ç…§ç‰‡URL');
                                // æ›´æ–°æœ¬åœ°ç…§ç‰‡URL
                                updateLocalPhotoUrl(photoData.id, downloadURL);
                            }, 20000); // 20ç§’è¶…æ—¶
                            
                            photosCollection.doc(photoData.id.toString()).set(photoToSave)
                                .then(() => {
                                    clearTimeout(firestoreTimeout); // æ¸…é™¤è¶…æ—¶
                                    console.log("ç…§ç‰‡æ•°æ®ä¿å­˜æˆåŠŸ! ID:", photoData.id);
                                    // æ›´æ–°æœ¬åœ°ç…§ç‰‡URL
                                    updateLocalPhotoUrl(photoData.id, downloadURL);
                                })
                                .catch(error => {
                                    clearTimeout(firestoreTimeout); // æ¸…é™¤è¶…æ—¶
                                    console.error("ä¿å­˜ç…§ç‰‡æ•°æ®å¤±è´¥:", error);
                                    console.error('é”™è¯¯ä»£ç :', error.code);
                                    console.error('é”™è¯¯ä¿¡æ¯:', error.message);
                                    // å°è¯•é‡è¯•Firestoreå†™å…¥
                                    if (retryCount < MAX_RETRIES) {
                                        const nextRetryCount = retryCount + 1;
                                        console.log(`å°†å¼€å§‹ç¬¬ ${nextRetryCount} æ¬¡Firestoreå†™å…¥é‡è¯•`);
                                        setTimeout(() => {
                                            console.log('é‡æ–°å°è¯•ä¿å­˜åˆ°Firestore...');
                                            const photoToRetrySave = {
                                                id: photoData.id,
                                                name: photoData.name,
                                                src: downloadURL,
                                                date: firebase.firestore.Timestamp.fromDate(new Date(photoData.date)),
                                                memory: photoData.memory || ''
                                            };
                                            console.log('é‡è¯•è¦ä¿å­˜çš„ç…§ç‰‡æ•°æ®:', photoToRetrySave);
                            
                                            // è®¾ç½®Firestoreå†™å…¥é‡è¯•è¶…æ—¶
                                            const retryFirestoreTimeout = setTimeout(() => {
                                                console.warn('é‡è¯•ä¿å­˜åˆ°Firestoreè¶…æ—¶ï¼Œå°†æ›´æ–°æœ¬åœ°ç…§ç‰‡URL');
                                                // æ›´æ–°æœ¬åœ°ç…§ç‰‡URL
                                                updateLocalPhotoUrl(photoData.id, downloadURL);
                                            }, 20000); // 20ç§’è¶…æ—¶
                            
                                            photosCollection.doc(photoData.id.toString()).set(photoToRetrySave)
                                                .then(() => {
                                                    clearTimeout(retryFirestoreTimeout); // æ¸…é™¤è¶…æ—¶
                                                    console.log('é‡è¯•ä¿å­˜æˆåŠŸ! ID:', photoData.id);
                                                    // æ›´æ–°æœ¬åœ°ç…§ç‰‡URL
                                                    updateLocalPhotoUrl(photoData.id, downloadURL);
                                                })
                                                .catch(err => {
                                                    clearTimeout(retryFirestoreTimeout); // æ¸…é™¤è¶…æ—¶
                                                    console.error('é‡è¯•ä¿å­˜ä»ç„¶å¤±è´¥:', err);
                                                    // ä»ç„¶æ›´æ–°æœ¬åœ°URL
                                                    updateLocalPhotoUrl(photoData.id, downloadURL);
                                                });
                                        }, 3000);
                                    } else {
                                        // è¶…è¿‡é‡è¯•æ¬¡æ•°ï¼Œä½†ä»æ›´æ–°æœ¬åœ°URL
                                        updateLocalPhotoUrl(photoData.id, downloadURL);
                                    }
                                })
                        }).catch(error => {
                            console.error('è·å–ä¸‹è½½é“¾æ¥å¤±è´¥:', error);
                            console.error('é”™è¯¯ä»£ç :', error.code);
                            console.error('é”™è¯¯ä¿¡æ¯:', error.message);
                            
                            // é‡è¯•è·å–ä¸‹è½½é“¾æ¥
                            if (retryCount < MAX_RETRIES) {
                                setTimeout(() => {
                                    console.log('é‡æ–°å°è¯•è·å–ä¸‹è½½é“¾æ¥...');
                                    uploadTask.snapshot.ref.getDownloadURL()
                                        .then(url => {
                                            console.log('é‡è¯•è·å–é“¾æ¥æˆåŠŸ:', url);
                                            // æ›´æ–°æœ¬åœ°å›¾ç‰‡é“¾æ¥
                                            updateLocalPhotoUrl(photoData.id, url);
                                        })
                                        .catch(err => {
                                            console.error('é‡è¯•è·å–é“¾æ¥ä»ç„¶å¤±è´¥:', err);
                                        });
                                }, 3000);
                            }
                            // å³ä½¿æ— æ³•è·å–é“¾æ¥ï¼Œä»ç„¶æ›´æ–°æœ¬åœ°å›¾ç‰‡
                            console.log('å°†ä½¿ç”¨åŸå§‹ç…§ç‰‡æ˜¾ç¤º');
                        });
                    }
                );
            } catch (error) {
                console.error('ä¸Šä¼ è¿‡ç¨‹å‘ç”Ÿé”™è¯¯:', error);
                // å¦‚æœå‘ç”Ÿå¼‚å¸¸ï¼Œä»ç„¶æ˜¾ç¤ºç…§ç‰‡ï¼ˆä»æœ¬åœ°å­˜å‚¨åŠ è½½ï¼‰
                loadPhotosFromLocalStorage();
                
                // é‡è¯•ä¸Šä¼ 
                if (retryCount < MAX_RETRIES) {
                    setTimeout(() => {
                        console.log(`å‘ç”Ÿå¼‚å¸¸ï¼Œå°†åœ¨ 5 ç§’åé‡è¯•ä¸Šä¼ (ç¬¬ ${retryCount + 1} æ¬¡)`);
                        uploadPhotoToFirebase(photoData, retryCount + 1);
                    }, 5000); // 5ç§’åé‡è¯•
                }
            }
        }

// æ›´æ–°æœ¬åœ°ç…§ç‰‡URL
function updateLocalPhotoUrl(photoId, newUrl) {
    console.log('æ›´æ–°æœ¬åœ°ç…§ç‰‡URL, ID:', photoId);
    const photoIndex = photos.findIndex(p => p.id === photoId);
    if (photoIndex !== -1) {
        // æ›´æ–°URL
        photos[photoIndex].src = newUrl;
        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        localStorage.setItem('photos', JSON.stringify(photos));
        console.log('æœ¬åœ°ç…§ç‰‡URLæ›´æ–°æˆåŠŸ');
        // é‡æ–°æ¸²æŸ“ç…§ç‰‡
        sortAndDisplayPhotos();
    } else {
        console.error('æœªæ‰¾åˆ°è¦æ›´æ–°URLçš„ç…§ç‰‡:', photoId);
    }
}
        
        // å°†base64è½¬æ¢ä¸ºBlob
        function dataURItoBlob(dataURI) {
            console.log('å¼€å§‹è½¬æ¢base64ä¸ºBlob...');
            try {
                // éªŒè¯æ˜¯å¦æ˜¯æœ‰æ•ˆçš„data URI
                if (!dataURI || typeof dataURI !== 'string' || !dataURI.includes('data:')) {
                    console.error('æ— æ•ˆçš„data URIæ ¼å¼');
                    throw new Error('æ— æ•ˆçš„å›¾ç‰‡æ ¼å¼');
                }
                
                // æå–MIMEç±»å‹å’Œbase64æ•°æ®
                const parts = dataURI.split(',');
                if (parts.length !== 2) {
                    console.error('data URIæ ¼å¼é”™è¯¯: ä¸è¶³ä¸¤éƒ¨åˆ†');
                    throw new Error('data URIæ ¼å¼é”™è¯¯');
                }
                
                const mimeMatch = parts[0].match(/:(.*?);/);
                if (!mimeMatch || mimeMatch.length < 2) {
                    console.error('data URIæ ¼å¼é”™è¯¯: æ— æ³•æå–MIMEç±»å‹');
                    throw new Error('æ— æ³•æå–å›¾ç‰‡ç±»å‹');
                }
                
                const mimeString = mimeMatch[1];
                console.log('å›¾ç‰‡MIMEç±»å‹:', mimeString);
                
                // è§£ç base64
                let byteString;
                try {
                    byteString = atob(parts[1]);
                } catch (e) {
                    console.error('base64è§£ç å¤±è´¥:', e);
                    throw new Error('base64è§£ç å¤±è´¥');
                }
                
                // åˆ›å»ºArrayBufferå’ŒUint8Array
                const ab = new ArrayBuffer(byteString.length);
                const ia = new Uint8Array(ab);
                
                for (let i = 0; i < byteString.length; i++) {
                    ia[i] = byteString.charCodeAt(i);
                }
                
                // åˆ›å»ºBlobå¯¹è±¡
                const blob = new Blob([ab], {type: mimeString});
                console.log('è½¬æ¢æˆåŠŸ, Blobå¤§å°:', blob.size, 'bytes, ç±»å‹:', blob.type);
                return blob;
            } catch (error) {
                console.error('å°†base64è½¬æ¢ä¸ºBlobæ—¶å‡ºé”™:', error);
                throw error; // å°†é”™è¯¯å‘ä¸ŠæŠ›å‡ºï¼Œä¾¿äºè°ƒç”¨å¤„æ•è·
            }
        }
        
        // ä¿å­˜ç…§ç‰‡åˆ°æœ¬åœ°å­˜å‚¨
        function savePhotoToLocalStorage(photoData) {
            let savedToLocalStorageSuccess = false;
            try {
                // è·å–å½“å‰å­˜å‚¨çš„ç…§ç‰‡
                let storedPhotos = JSON.parse(localStorage.getItem('photos') || '[]');
                
                // æ·»åŠ æ–°ç…§ç‰‡
                storedPhotos.push(photoData);
                
                // ä¿å­˜å›æœ¬åœ°å­˜å‚¨
                localStorage.setItem('photos', JSON.stringify(storedPhotos));
                savedToLocalStorageSuccess = true;
                console.log('ç…§ç‰‡å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
            } catch (error) {
                console.error('ä¿å­˜ç…§ç‰‡åˆ°æœ¬åœ°å­˜å‚¨å¤±è´¥ (QuotaExceededErrorå¾ˆå¯èƒ½å‘ç”Ÿ):', error);
                // å³ä½¿ä¿å­˜åˆ°LocalStorageå¤±è´¥ï¼Œæˆ‘ä»¬ä»ç„¶å¸Œæœ›åœ¨UIä¸Šæ˜¾ç¤ºå®ƒ
                // åç»­çš„Firebaseä¸Šä¼ ä¼šè´Ÿè´£æŒä¹…åŒ–å­˜å‚¨
            }

            // æ— è®ºLocalStorageæ˜¯å¦ä¿å­˜æˆåŠŸï¼Œéƒ½æ›´æ–°å†…å­˜ä¸­çš„ç…§ç‰‡æ•°ç»„å¹¶æ˜¾ç¤º
            // è¿™æ ·ç”¨æˆ·å¯ä»¥ç«‹å³çœ‹åˆ°ä¸Šä¼ çš„å›¾ç‰‡
            const photoExistsInMemory = photos.some(p => p.id === photoData.id);
            if (!photoExistsInMemory) {
                photos.push(photoData);
            }
            sortAndDisplayPhotos();
            
            if (!savedToLocalStorageSuccess) {
                // å¯ä»¥é€‰æ‹©æ€§åœ°ç»™ç”¨æˆ·ä¸€ä¸ªæç¤ºï¼Œå‘ŠçŸ¥å›¾ç‰‡å¯èƒ½æœªå®Œå…¨åœ¨æœ¬åœ°ç¼“å­˜
                // console.warn('æç¤º: ç…§ç‰‡æœªèƒ½å®Œæ•´ç¼“å­˜åœ¨æœ¬åœ°ï¼Œä½†ä¼šå°è¯•ä¸Šä¼ åˆ°äº‘ç«¯ã€‚');
            }
        }
        
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½ç…§ç‰‡
        function loadPhotosFromLocalStorage() {
            try {
                const storedPhotos = JSON.parse(localStorage.getItem('photos') || '[]');
                if (storedPhotos.length > 0) {
                    photos = storedPhotos.map(photo => {
                        // ç¡®ä¿æ—¥æœŸæ˜¯Dateå¯¹è±¡
                        return {
                            ...photo,
                            date: new Date(photo.date)
                        };
                    });
                    sortAndDisplayPhotos();
                    console.log('ä»æœ¬åœ°å­˜å‚¨åŠ è½½äº†', photos.length, 'å¼ ç…§ç‰‡');
                }
            } catch (error) {
                console.error('ä»æœ¬åœ°å­˜å‚¨åŠ è½½ç…§ç‰‡å¤±è´¥:', error);
                photos = [];
                sortAndDisplayPhotos();
            }
        }
        
        // åˆå¹¶æœ¬åœ°å’ŒFirestoreç…§ç‰‡
        function mergePhotos(firebasePhotos) {
            console.log('å¼€å§‹åˆå¹¶æœ¬åœ°å’ŒFirestoreç…§ç‰‡...');
            if (firebasePhotos.length > 0) {
                console.log('ä»FirestoreåŠ è½½äº†', firebasePhotos.length, 'å¼ ç…§ç‰‡');
                
                // è·å–æœ¬åœ°ç…§ç‰‡
                const localPhotos = JSON.parse(localStorage.getItem('photos') || '[]');
                console.log('æœ¬åœ°å­˜å‚¨ä¸­æœ‰', localPhotos.length, 'å¼ ç…§ç‰‡');
                const allPhotoIds = new Set();
                
                // å…ˆæ·»åŠ Firestoreç…§ç‰‡
                photos = firebasePhotos;
                firebasePhotos.forEach(photo => allPhotoIds.add(photo.id));
                
                // æ·»åŠ æœ¬åœ°ç‹¬æœ‰çš„ç…§ç‰‡
                let localOnlyCount = 0;
                localPhotos.forEach(photo => {
                    if (!allPhotoIds.has(photo.id)) {
                        console.log('å‘ç°æœ¬åœ°ç‹¬æœ‰ç…§ç‰‡:', photo.id);
                        localOnlyCount++;
                        photos.push({
                            ...photo,
                            date: new Date(photo.date)
                        });
                        // å°è¯•å°†æœ¬åœ°ç‹¬æœ‰ç…§ç‰‡ä¹Ÿä¸Šä¼ åˆ°Firestore
                        uploadPhotoToFirebase(photo);
                    }
                });
                console.log('æ·»åŠ äº†', localOnlyCount, 'å¼ æœ¬åœ°ç‹¬æœ‰ç…§ç‰‡');
                
                // æ›´æ–°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('photos', JSON.stringify(photos));
                console.log('å·²æ›´æ–°æœ¬åœ°å­˜å‚¨, åˆè®¡', photos.length, 'å¼ ç…§ç‰‡');
                
                // æ’åºå¹¶æ˜¾ç¤ºç…§ç‰‡
                sortAndDisplayPhotos();
            } else {
                console.log('Firestoreä¸­æ²¡æœ‰ç…§ç‰‡ï¼Œä½¿ç”¨æœ¬åœ°å­˜å‚¨');
                loadPhotosFromLocalStorage();
            }
        }
        
        // ä»FirebaseåŠ è½½ç…§ç‰‡
        function loadPhotosFromFirebase() {
            console.log('å¼€å§‹ä»FirestoreåŠ è½½ç…§ç‰‡...');
            // å°è¯•ä½¿ç”¨é€šç”¨æŸ¥è¯¢ï¼Œä¸ä¾èµ–äºç‰¹å®šç”¨æˆ·
            photosCollection.get()
                .then(snapshot => {
                    console.log('æˆåŠŸè·å–Firestoreæ•°æ®, æ–‡æ¡£æ•°:', snapshot.size);
                    const firebasePhotos = [];
                    snapshot.forEach(doc => {
                        const photoData = doc.data();
                        console.log('å¤„ç†ç…§ç‰‡æ–‡æ¡£:', doc.id, photoData);
                        firebasePhotos.push({
                            id: photoData.id,
                            name: photoData.name,
                            src: photoData.src,
                            date: photoData.date && photoData.date.toDate ? photoData.date.toDate() : new Date(photoData.date || Date.now()),
                            memory: photoData.memory || ''
                        });
                    });
                    
                    console.log('ä»FirestoreåŠ è½½äº†', firebasePhotos.length, 'å¼ ç…§ç‰‡');
                    if (firebasePhotos.length > 0) {
                        console.log('ç¬¬ä¸€å¼ ç…§ç‰‡æ ·ä¾‹:', firebasePhotos[0]);
                    }
                    
                    // åˆå¹¶æœ¬åœ°å’ŒFirebaseç…§ç‰‡
                    mergePhotos(firebasePhotos);
                    
                    // è®¾ç½®å®æ—¶ç›‘å¬
                    setupRealtimeListener();
                })
                .catch(error => {
                    console.error('ä»FirestoreåŠ è½½ç…§ç‰‡å¤±è´¥:', error);
                    console.error('é”™è¯¯ä»£ç :', error.code);
                    console.error('é”™è¯¯ä¿¡æ¯:', error.message);
                    loadPhotosFromLocalStorage();
                });
}

// è®¾ç½®å®æ—¶æ•°æ®ç›‘å¬
function setupRealtimeListener() {
    console.log('è®¾ç½® Firestore å®æ—¶ç›‘å¬å™¨...');
    console.log('ä½¿ç”¨å…±äº«è®¿é—®è¿›è¡Œç›‘å¬ï¼Œè®¿é—®å¯†é’¥:', sharedAccessKey);
            // å–æ¶ˆä¹‹å‰çš„ç›‘å¬å™¨
            let unsubscribeAdded;
            
            // ç›‘å¬æ–°ç…§ç‰‡æ·»åŠ å’Œæ›´æ–°
            unsubscribeAdded = photosCollection.onSnapshot(snapshot => {
                console.log('æ”¶åˆ° Firestore æ•°æ®å˜åŒ–, å˜åŒ–æ•°:', snapshot.docChanges().length);
                
                snapshot.docChanges().forEach(change => {
                    console.log('å˜åŒ–ç±»å‹:', change.type, 'æ–‡æ¡£ID:', change.doc.id);
                    const photoData = change.doc.data();
                    console.log('ç…§ç‰‡æ•°æ®:', photoData);
                    
                    if (change.type === 'added') {
                        // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æ­¤ç…§ç‰‡
                        const existingIndex = photos.findIndex(p => p.id === photoData.id);
                        console.log('æ£€æŸ¥ç…§ç‰‡æ˜¯å¦å­˜åœ¨, ID:', photoData.id, 'ç´¢å¼•:', existingIndex);
                        
                        if (existingIndex === -1) {
                            // æ·»åŠ æ–°ç…§ç‰‡
                            const newPhoto = {
                                id: photoData.id,
                                name: photoData.name,
                                src: photoData.src,
                                date: photoData.date && photoData.date.toDate ? photoData.date.toDate() : new Date(photoData.date || Date.now()),
                                memory: photoData.memory || ''
                            };
                            photos.push(newPhoto);
                            console.log('æ·»åŠ æ–°ç…§ç‰‡åˆ°æ•°ç»„:', newPhoto);
                            
                            // æ›´æ–°æœ¬åœ°å­˜å‚¨
                            localStorage.setItem('photos', JSON.stringify(photos));
                            console.log('å·²æ›´æ–°æœ¬åœ°å­˜å‚¨, æ€»ç…§ç‰‡æ•°:', photos.length);
                            
                            // é‡æ–°æ’åºå’Œæ˜¾ç¤º
                            sortAndDisplayPhotos();
                            console.log('æ–°ç…§ç‰‡æ·»åŠ å®Œæˆ:', photoData.id);
                        }
                    }
                    
                    if (change.type === 'modified') {
                        // æ›´æ–°å·²å­˜åœ¨çš„ç…§ç‰‡
                        const existingIndex = photos.findIndex(p => p.id === photoData.id);
                        console.log('æ£€æŸ¥è¦æ›´æ–°çš„ç…§ç‰‡, ID:', photoData.id, 'ç´¢å¼•:', existingIndex);
                        
                        if (existingIndex !== -1) {
                            const updatedPhoto = {
                                id: photoData.id,
                                name: photoData.name,
                                src: photoData.src,
                                date: photoData.date && photoData.date.toDate ? photoData.date.toDate() : new Date(photoData.date || Date.now()),
                                memory: photoData.memory || ''
                            };
                            photos[existingIndex] = updatedPhoto;
                            console.log('æ›´æ–°ç°æœ‰ç…§ç‰‡:', updatedPhoto);
                            
                            // æ›´æ–°æœ¬åœ°å­˜å‚¨
                            localStorage.setItem('photos', JSON.stringify(photos));
                            console.log('å·²æ›´æ–°æœ¬åœ°å­˜å‚¨, æ€»ç…§ç‰‡æ•°:', photos.length);
                            
                            // é‡æ–°æ’åºå’Œæ˜¾ç¤º
                            sortAndDisplayPhotos();
                            console.log('ç…§ç‰‡æ›´æ–°å®Œæˆ:', photoData.id);
                        }
                    }
                });
            }, error => {
                console.error('Firestoreç›‘å¬é”™è¯¯:', error);
                console.error('é”™è¯¯ä»£ç :', error.code);
                console.error('é”™è¯¯ä¿¡æ¯:', error.message);
            });
            
            console.log('Firestore å®æ—¶ç›‘å¬å™¨è®¾ç½®å®Œæˆ');
}

// æµ‹è¯•Firebaseå®‰å…¨è§„åˆ™
function testFirebaseRules() {
    console.log('å¼€å§‹æµ‹è¯•Firebaseå®‰å…¨è§„åˆ™...');
    console.log('ä½¿ç”¨å…±äº«è®¿é—®å¯†é’¥:', sharedAccessKey);
            
            // æµ‹è¯•Firestoreè¯»å–æƒé™
            photosCollection.limit(1).get()
                .then(snapshot => {
                    console.log('Firestoreè¯»å–æƒé™æµ‹è¯•æˆåŠŸ');
                })
                .catch(error => {
                    console.error('Firestoreè¯»å–æƒé™æµ‹è¯•å¤±è´¥:', error);
                    console.error('é”™è¯¯ä»£ç :', error.code);
                    console.error('é”™è¯¯ä¿¡æ¯:', error.message);
                    alert('è¯·æ£€æŸ¥Firebase Firestoreå®‰å…¨è§„åˆ™ï¼Œç¡®ä¿å·²è®¾ç½®ä¸º allow read, write: if true;');
                });
            
            // æµ‹è¯•Firestoreå†™å…¥æƒé™
            const testDocId = 'test-' + Date.now();
            photosCollection.doc(testDocId).set({test: true})
                .then(() => {
                    console.log('Firestoreå†™å…¥æƒé™æµ‹è¯•æˆåŠŸ');
                    // æ¸…ç†æµ‹è¯•æ•°æ®
                    photosCollection.doc(testDocId).delete()
                        .then(() => console.log('æµ‹è¯•æ•°æ®å·²æ¸…ç†'))
                        .catch(e => console.error('æ¸…ç†æµ‹è¯•æ•°æ®å¤±è´¥:', e));
                })
                .catch(error => {
                    console.error('Firestoreå†™å…¥æƒé™æµ‹è¯•å¤±è´¥:', error);
                    console.error('é”™è¯¯ä»£ç :', error.code);
                    console.error('é”™è¯¯ä¿¡æ¯:', error.message);
                    alert('è¯·æ£€æŸ¥Firebase Firestoreå®‰å…¨è§„åˆ™ï¼Œç¡®ä¿å·²è®¾ç½®ä¸º allow read, write: if true;');
                });
            
            // æµ‹è¯•Storageå†™å…¥æƒé™
            const testBlob = new Blob(['test'], {type: 'text/plain'});
            const testRef = storage.ref('test/test-' + Date.now() + '.txt');
            testRef.put(testBlob)
                .then(() => {
                    console.log('Storageå†™å…¥æƒé™æµ‹è¯•æˆåŠŸ');
                    // æ¸…ç†æµ‹è¯•æ•°æ®
                    testRef.delete()
                        .then(() => console.log('Storageæµ‹è¯•æ•°æ®å·²æ¸…ç†'))
                        .catch(e => console.error('æ¸…ç†Storageæµ‹è¯•æ•°æ®å¤±è´¥:', e));
                })
                .catch(error => {
                    console.error('Storageå†™å…¥æƒé™æµ‹è¯•å¤±è´¥:', error);
                    console.error('é”™è¯¯ä»£ç :', error.code);
                    console.error('é”™è¯¯ä¿¡æ¯:', error.message);
                    alert('è¯·æ£€æŸ¥Firebase Storageå®‰å…¨è§„åˆ™ï¼Œç¡®ä¿å·²è®¾ç½®ä¸º allow read, write: if true;');
                });
        }
        
        // æ’åºå¹¶æ˜¾ç¤ºç…§ç‰‡
        function sortAndDisplayPhotos() {
            // æ’åºç…§ç‰‡
            photos.sort((a, b) => {
                const dateA = new Date(a.date);
                const dateB = new Date(b.date);
                
                if (currentSort === 'date-desc') {
                    return dateB - dateA;
                } else {
                    return dateA - dateB;
                }
            });
            
            // æ¸…ç©ºå®¹å™¨
            const container = document.getElementById('photos-container');
            container.innerHTML = '';
            
            // æ˜¾ç¤ºç…§ç‰‡
            photos.forEach(photo => {
                const photoCard = document.createElement('div');
                photoCard.className = 'photo-card';
                
                const img = document.createElement('img');
                img.src = photo.src;
                img.className = 'photo-img';
                img.alt = photo.name;
                img.onclick = function() {
                    openModal(photo.src);
                };
                
                const dateElement = document.createElement('div');
                dateElement.className = 'photo-date';
                dateElement.textContent = formatDate(photo.date);
                
                const memoryDiv = document.createElement('div');
                memoryDiv.className = 'photo-memory';
                
                const memoryText = document.createElement('p');
                memoryText.textContent = photo.memory || 'ç‚¹å‡»æ·»åŠ å›å¿†...';
                memoryText.style.cursor = 'pointer';
                memoryText.onclick = function() {
                    this.style.display = 'none';
                    memoryInput.style.display = 'block';
                    saveBtn.style.display = 'block';
                    memoryInput.focus();
                };
                
                const memoryInput = document.createElement('textarea');
                memoryInput.className = 'photo-memory-input';
                memoryInput.value = photo.memory || '';
                memoryInput.placeholder = 'å†™ä¸‹è¿™å¼ ç…§ç‰‡çš„å›å¿†...';
                memoryInput.style.display = 'none';
                
                const saveBtn = document.createElement('button');
                saveBtn.className = 'save-memory-btn';
                saveBtn.textContent = 'ä¿å­˜å›å¿†';
                saveBtn.style.display = 'none';
                saveBtn.onclick = function() {
                    saveMemory(photo.id, memoryInput.value);
                    memoryText.textContent = memoryInput.value || 'ç‚¹å‡»æ·»åŠ å›å¿†...';
                    memoryInput.style.display = 'none';
                    saveBtn.style.display = 'none';
                    memoryText.style.display = 'block';
                };
                
                memoryDiv.appendChild(memoryText);
                memoryDiv.appendChild(memoryInput);
                memoryDiv.appendChild(saveBtn);
                
                // åˆ›å»ºåˆ é™¤æŒ‰é’®
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-btn';
                deleteBtn.innerHTML = '&#10005;'; // æ·»åŠ ä¸€ä¸ªXç¬¦å·
                deleteBtn.title = 'åˆ é™¤ç…§ç‰‡';
                deleteBtn.onclick = function(e) {
                    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†²çª
                    deletePhoto(photo.id);
                };
                
                photoCard.appendChild(img);
                photoCard.appendChild(dateElement);
                photoCard.appendChild(memoryDiv);
                photoCard.appendChild(deleteBtn);
                
                container.appendChild(photoCard);
            });
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(date) {
            const options = { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            };
            return new Date(date).toLocaleDateString('zh-CN', options);
        }
        
        // ä¿å­˜å›å¿†
        function saveMemory(photoId, memory) {
            console.log('å¼€å§‹ä¿å­˜å›å¿†, ç…§ç‰‡ID:', photoId);
            // æ›´æ–°æœ¬åœ°ç…§ç‰‡æ•°æ®
            const photoIndex = photos.findIndex(p => p.id === photoId);
            if (photoIndex !== -1) {
                photos[photoIndex].memory = memory;
                console.log('æ›´æ–°äº†æœ¬åœ°ç…§ç‰‡å›å¿†');
                
                // æ›´æ–°æœ¬åœ°å­˜å‚¨
                localStorage.setItem('photos', JSON.stringify(photos));
                console.log('å›å¿†å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
                
                // å¦‚æœå·²ç™»å½•ï¼Œæ›´æ–°Firestore
                if (auth.currentUser) {
                    photosCollection.doc(photoId.toString()).update({
                        memory: memory
                    }).then(() => {
                        console.log('å›å¿†å·²ä¿å­˜åˆ°Firestore');
                    }).catch(error => {
                        console.error('ä¿å­˜å›å¿†åˆ°Firestoreå¤±è´¥:', error);
                        console.error('é”™è¯¯ä»£ç :', error.code);
                        console.error('é”™è¯¯ä¿¡æ¯:', error.message);
                    });
                }
            }
        }
        
        // æ‰“å¼€æ¨¡æ€æ¡†
        function openModal(src) {
            const modal = document.getElementById('modal');
            const modalImg = document.getElementById('modal-img');
            
            modal.style.display = 'flex';
            modalImg.src = src;
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }
        
        // æ›´æ”¹æ’åºæ–¹å¼
        function changeSort(sortType) {
            console.log('æ›´æ”¹æ’åºæ–¹å¼ä¸º:', sortType);
            currentSort = sortType;
            
            // æ›´æ–°æ’åºæŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.sort-btn').forEach(btn => {
                if (btn.getAttribute('onclick').includes(sortType)) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // é‡æ–°æ’åºå’Œæ˜¾ç¤º
            sortAndDisplayPhotos();
        }
        
        // åˆ é™¤ç…§ç‰‡
        function deletePhoto(photoId) {
            console.log('å¼€å§‹åˆ é™¤ç…§ç‰‡, ID:', photoId);
            
            // ç¡®è®¤åˆ é™¤
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ ç…§ç‰‡å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
                console.log('ç”¨æˆ·å–æ¶ˆåˆ é™¤');
                return;
            }
            
            // ä»æœ¬åœ°æ•°ç»„ä¸­åˆ é™¤
            const photoIndex = photos.findIndex(p => p.id === photoId);
            if (photoIndex === -1) {
                console.error('æœªæ‰¾åˆ°è¦åˆ é™¤çš„ç…§ç‰‡:', photoId);
                return;
            }
            
            const photoToDelete = photos[photoIndex];
            console.log('æ‰¾åˆ°è¦åˆ é™¤çš„ç…§ç‰‡:', photoToDelete);
            
            // ä»æ•°ç»„ä¸­ç§»é™¤
            photos.splice(photoIndex, 1);
            console.log('ä»æœ¬åœ°æ•°ç»„ä¸­åˆ é™¤ç…§ç‰‡æˆåŠŸ');
            
            // æ›´æ–°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('photos', JSON.stringify(photos));
            console.log('æ›´æ–°æœ¬åœ°å­˜å‚¨æˆåŠŸ');
            
            // é‡æ–°æ¸²æŸ“ç…§ç‰‡åˆ—è¡¨
            sortAndDisplayPhotos();
            
            // å¦‚æœå·²ç™»å½•ï¼Œä» Firestore å’Œ Storage ä¸­åˆ é™¤
            if (auth.currentUser) {
                // ä» Firestore ä¸­åˆ é™¤æ–‡æ¡£
                photosCollection.doc(photoId.toString()).delete()
                    .then(() => {
                        console.log('Firestore æ–‡æ¡£åˆ é™¤æˆåŠŸ:', photoId);
                        
                        // å¦‚æœç…§ç‰‡é“¾æ¥æ˜¯æ¥è‡ªStorageçš„ï¼Œåˆ™åˆ é™¤Storageæ–‡ä»¶
                        if (photoToDelete.src && photoToDelete.src.includes('firebasestorage.googleapis.com')) {
                            // ä» URL æå–æ–‡ä»¶è·¯å¾„
                            try {
                                const storageRef = storage.ref(`photos/${photoId}`);
                                storageRef.delete()
                                    .then(() => {
                                        console.log('Storage æ–‡ä»¶åˆ é™¤æˆåŠŸ:', photoId);
                                    })
                                    .catch(error => {
                                        console.error('Storage æ–‡ä»¶åˆ é™¤å¤±è´¥:', error);
                                        console.error('é”™è¯¯ä»£ç :', error.code);
                                        console.error('é”™è¯¯ä¿¡æ¯:', error.message);
                                    });
                            } catch (error) {
                                console.error('å¤„ç†Storageæ–‡ä»¶åˆ é™¤æ—¶å‡ºé”™:', error);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Firestore æ–‡æ¡£åˆ é™¤å¤±è´¥:', error);
                        console.error('é”™è¯¯ä»£ç :', error.code);
                        console.error('é”™è¯¯ä¿¡æ¯:', error.message);
                    });
            }
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('modal');
            if (event.target === modal) {
                closeModal();
            }
        };
        
        
        // é¡µé¢åŠ è½½å®Œæˆæ—¶çš„äº‹ä»¶å¤„ç†
        window.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢åŠ è½½å®Œæˆ');
            
            // ç¡®ä¿ä¸Šä¼ æŒ‰é’®ç›‘å¬å™¨è¢«è®¾ç½®ï¼Œæ— è®ºç™»å½•æ˜¯å¦æˆåŠŸ
            setTimeout(function() {
                // å¦‚æœ5ç§’åä»æœªè®¾ç½®ä¸Šä¼ ç›‘å¬å™¨ï¼Œåˆ™å¼ºåˆ¶è®¾ç½®
                setupUploadListener();
                console.log('ç¡®ä¿ä¸Šä¼ æŒ‰é’®ç›‘å¬å™¨å·²è®¾ç½®');
                
                // å¦‚æœå›¾ç‰‡è¿˜æœªåŠ è½½ï¼Œå°è¯•å†æ¬¡åŠ è½½
                if (photos.length === 0) {
                    loadPhotosFromLocalStorage();
                }
            }, 5000);
        });
    </script>
</body>
</html>
